// ============================================================================
// PITCHCONNECT DATABASE SCHEMA (Prisma ORM)
// PostgreSQL via Supabase
// Production-ready with TypeScript strict mode support
// ENHANCED: Table mappings, Match Attendance, Treasurer, Coach Timesheets
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  SUPERADMIN
  PLAYER
  PLAYER_PRO
  COACH
  CLUB_MANAGER
  LEAGUE_ADMIN
  PARENT
  TREASURER // ðŸ†• NEW: Financial management role
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

enum TeamType {
  PROFESSIONAL
  SEMI_PROFESSIONAL
  AMATEUR
  YOUTH
  POWERLEAGUE
}

enum Position {
  GOALKEEPER
  DEFENDER
  MIDFIELDER
  FORWARD
}

enum PreferredFoot {
  LEFT
  RIGHT
  BOTH
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FINISHED
  CANCELLED
  POSTPONED
}

// ðŸ†• NEW: Match Attendance Status
enum MatchAttendanceStatus {
  AVAILABLE           // Player confirms availability
  UNAVAILABLE         // Player cannot attend
  CONFIRMED           // Coach/Manager confirmed attendance
  MAYBE               // Uncertain availability
  LATE                // Player arrived late
  NO_SHOW             // Player didn't show up
  EXCUSED_ABSENCE     // Approved absence (injury, personal, etc.)
  INJURED             // Injured and cannot play
  ILL                 // Sick/unwell
  SUSPENDED           // Serving suspension
  NOT_SELECTED        // Not selected for squad
  SUBSTITUTE          // Selected as substitute
  STARTING_LINEUP     // Selected in starting XI
  ATTENDED            // Attended the match
}

enum MatchEventType {
  GOAL
  ASSIST
  YELLOW_CARD
  RED_CARD
  SUBSTITUTION
  INJURY_TIME
  FULLTIME
  HALFTIME
  KICKOFF
}

enum Formation {
  FOUR_FOUR_TWO
  FOUR_THREE_THREE
  THREE_FIVE_TWO
  FIVE_THREE_TWO
  FIVE_FOUR_ONE
  THREE_FOUR_THREE
  FOUR_TWO_THREE_ONE
  FOUR_ONE_FOUR_ONE
}

enum SubscriptionTier {
  FREE
  PLAYER_PRO
  COACH
  MANAGER
  LEAGUE_ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
  PAST_DUE
  TRIAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  MATCH_SCHEDULED
  MATCH_REMINDER
  TRAINING_SESSION
  TEAM_MESSAGE
  ACHIEVEMENT_UNLOCKED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PLAYER_STATS_UPDATE
  SYSTEM_ALERT
  UPGRADE_REQUEST_APPROVED
  UPGRADE_REQUEST_REJECTED
  ROLE_CHANGED
  ACCOUNT_SUSPENDED
  MATCH_ATTENDANCE_REQUEST // ðŸ†• NEW
  TIMESHEET_APPROVED       // ðŸ†• NEW
  TIMESHEET_REJECTED       // ðŸ†• NEW
  PAYMENT_PROCESSED        // ðŸ†• NEW
}

enum TrainingIntensity {
  LOW
  MEDIUM
  HIGH
}

enum TrainingCategory {
  PASSING
  SHOOTING
  DEFENDING
  POSSESSION
  SET_PIECES
  CONDITIONING
  TACTICAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum UpgradeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  USER_BANNED
  USER_UNBANNED
  ROLE_UPGRADED
  ROLE_DOWNGRADED
  SUBSCRIPTION_GRANTED
  SUBSCRIPTION_CANCELLED
  PAYMENT_REFUNDED
  DATA_EXPORTED
  BULK_OPERATION
  UPGRADE_REQUEST_APPROVED
  UPGRADE_REQUEST_REJECTED
  TIMESHEET_SUBMITTED     // ðŸ†• NEW
  TIMESHEET_APPROVED      // ðŸ†• NEW
  PAYMENT_PROCESSED       // ðŸ†• NEW
}

// ðŸ†• NEW: Timesheet Status
enum TimesheetStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PAID
}

// ðŸ†• NEW: Payment Type
enum PaymentType {
  SUBSCRIPTION
  COACHING_FEE
  MATCH_FEE
  TOURNAMENT_FEE
  REFUND
  OTHER
}

// ============================================================================
// USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  firstName     String
  lastName      String
  phoneNumber   String?
  avatar        String?
  dateOfBirth   DateTime?

  roles  UserRole[]
  status UserStatus @default(PENDING_VERIFICATION)

  isSuperAdmin  Boolean   @default(false)
  lastLoginIp   String?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  accounts            Account[]
  sessions            Session[]
  preferences         UserPreferences?
  playerProfile       Player?
  coachProfile        Coach?
  clubManager         ClubManager?
  leagueAdmin         LeagueAdmin?
  parentProfile       Parent?
  treasurerProfile    Treasurer? // ðŸ†• NEW
  subscription        Subscription?
  payments            Payment[]
  notifications       Notification[]
  scoutingReports     ScoutingProfile[]
  sentMessages        Message[]            @relation("MessageSender")
  upgradeRequests     UpgradeRequest[]
  auditLogs           AuditLog[]           @relation("AuditUser")
  performedAudits     AuditLog[]           @relation("AuditPerformer")
  approvedTimesheets  CoachTimesheet[]     @relation("TimesheetApprover") // ðŸ†• NEW
  processedPayments   CoachPayment[]       @relation("PaymentProcessor") // ðŸ†• NEW

  @@index([email])
  @@index([status])
  @@index([isSuperAdmin])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  theme    String @default("auto")
  language String @default("en-GB")
  timezone String @default("Europe/London")
  currency String @default("GBP")

  notificationsEmail Boolean @default(true)
  notificationsSMS   Boolean @default(false)
  notificationsPush  Boolean @default(true)

  privateProfile Boolean @default(false)
  analyticsLevel String  @default("BASIC")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================================================
// UPGRADE REQUEST SYSTEM
// ============================================================================

model UpgradeRequest {
  id            String               @id @default(cuid())
  userId        String
  currentRole   UserRole
  requestedRole UserRole
  reason        String               @db.Text
  status        UpgradeRequestStatus @default(PENDING)

  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("upgrade_requests")
}

// ============================================================================
// PLAYER MODELS
// ============================================================================

model Player {
  id     String @id @default(cuid())
  userId String @unique

  firstName   String
  lastName    String
  dateOfBirth DateTime
  nationality String
  height      Float?
  weight      Float?

  position      Position
  preferredFoot PreferredFoot
  shirtNumber   Int?
  photo         String?

  status           String  @default("ACTIVE")
  developmentNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  stats              PlayerStats[]
  teams              TeamPlayer[]
  achievements       PlayerAchievement[]
  scoutingProfiles   ScoutingProfile[]
  matchEvents        MatchEvent[]
  trainingAttendance TrainingAttendance[]
  tacticPositions    TacticPlayer[]
  matchAttendance    MatchAttendance[] // ðŸ†• NEW

  @@index([userId])
  @@index([position])
  @@map("players")
}

model PlayerStats {
  id       String @id @default(cuid())
  playerId String
  season   Int

  appearances   Int @default(0)
  goals         Int @default(0)
  assists       Int @default(0)
  minutesPlayed Int @default(0)

  passingAccuracy Float?
  tackles         Int?
  interceptions   Int?
  shotsOnTarget   Int?

  sprintDistance Float?
  topSpeed       Float?
  acceleration   Float?

  expectedGoals   Float?
  expectedAssists Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season])
  @@index([playerId])
  @@index([season])
  @@map("player_stats")
}

// ============================================================================
// COACH & CLUB MODELS
// ============================================================================

model Coach {
  id     String @id @default(cuid())
  userId String @unique

  bio             String?  @db.Text
  yearsExperience Int?
  qualifications  String[]
  specializations String[]

  // ðŸ†• NEW: Payment details
  hourlyRate   Float?
  bankDetails  Json? // Encrypted bank account info
  taxId        String?
  contractType String? // PERMANENT, FREELANCE, PART_TIME

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  teams            Team[]
  trainingSessions TrainingSession[]
  tactics          Tactic[]
  timesheets       CoachTimesheet[] // ðŸ†• NEW
  payments         CoachPayment[]   // ðŸ†• NEW

  @@index([userId])
  @@map("coaches")
}

model ClubManager {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clubs Club[]

  @@index([userId])
  @@map("club_managers")
}

// ðŸ†• NEW: Treasurer Model
model Treasurer {
  id     String @id @default(cuid())
  userId String @unique

  clubId String?
  permissions Json? // What they can approve/reject

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clubId])
  @@map("treasurers")
}

model Club {
  id       String    @id @default(cuid())
  name     String
  code     String    @unique
  logo     String?
  founded  DateTime?
  city     String
  country  String
  teamType TeamType
  status   String    @default("ACTIVE")

  email   String?
  phone   String?
  website String?

  managerId String
  manager   ClubManager @relation(fields: [managerId], references: [id])
  teams     Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([managerId])
  @@map("clubs")
}

model Team {
  id       String @id @default(cuid())
  clubId   String
  name     String
  category String
  season   Int
  status   String @default("ACTIVE")

  club              Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coachId           String
  coach             Coach             @relation(fields: [coachId], references: [id])
  players           TeamPlayer[]
  homeMatches       Match[]           @relation("HomeTeam")
  awayMatches       Match[]           @relation("AwayTeam")
  trainingSessions  TrainingSession[]
  tactics           Tactic[]
  leagueMemberships LeagueTeam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clubId])
  @@index([coachId])
  @@index([season])
  @@map("teams")
}

model TeamPlayer {
  id        String    @id @default(cuid())
  teamId    String
  playerId  String
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isCaptain Boolean   @default(false)

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@index([playerId])
  @@map("team_players")
}

// ============================================================================
// LEAGUE & FIXTURES MODELS
// ============================================================================

model League {
  id      String  @id @default(cuid())
  name    String
  code    String  @unique
  logo    String?
  country String
  season  Int
  status  String  @default("ACTIVE")

  pointsWin  Int @default(3)
  pointsDraw Int @default(1)
  pointsLoss Int @default(0)

  adminId   String
  admin     LeagueAdmin  @relation(fields: [adminId], references: [id])
  teams     LeagueTeam[]
  fixtures  Fixture[]
  standings Standings[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([adminId])
  @@index([season])
  @@map("leagues")
}

model LeagueAdmin {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leagues League[]

  @@index([userId])
  @@map("league_admins")
}

model LeagueTeam {
  id       String    @id @default(cuid())
  leagueId String
  teamId   String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([teamId])
  @@map("league_teams")
}

model Fixture {
  id        String @id @default(cuid())
  leagueId  String
  matchweek Int
  season    Int
  status    String @default("UPCOMING")

  league  League  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  matches Match[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leagueId])
  @@index([matchweek])
  @@index([season])
  @@map("fixtures")
}

model Standings {
  id       String @id @default(cuid())
  leagueId String
  teamId   String
  position Int

  played Int @default(0)
  won    Int @default(0)
  drawn  Int @default(0)
  lost   Int @default(0)

  goalsFor       Int @default(0)
  goalsAgainst   Int @default(0)
  goalDifference Int @default(0)

  points Int @default(0)

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([position])
  @@map("standings")
}

// ============================================================================
// MATCH & EVENT MODELS
// ============================================================================

model Match {
  id         String      @id @default(cuid())
  fixtureId  String?
  homeTeamId String
  awayTeamId String
  date       DateTime
  venue      String?
  status     MatchStatus @default(SCHEDULED)

  homeGoals  Int?
  awayGoals  Int?
  attendance Int?

  // ðŸ†• NEW: Attendance deadline
  attendanceDeadline DateTime?

  fixture           Fixture?           @relation(fields: [fixtureId], references: [id], onDelete: SetNull)
  homeTeam          Team               @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam          Team               @relation("AwayTeam", fields: [awayTeamId], references: [id])
  events            MatchEvent[]
  stats             MatchStats?
  playerAttendances MatchAttendance[] // ðŸ†• NEW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fixtureId])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([date])
  @@index([status])
  @@map("matches")
}

// ðŸ†• NEW: Match Attendance Model
model MatchAttendance {
  id       String                 @id @default(cuid())
  matchId  String
  playerId String
  status   MatchAttendanceStatus  @default(AVAILABLE)
  
  // Response tracking
  respondedAt    DateTime?
  confirmedBy    String? // Coach/Manager who confirmed
  notes          String?  @db.Text
  
  // Performance tracking (filled post-match)
  minutesPlayed  Int?
  performanceRating Float?
  
  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@index([status])
  @@map("match_attendance")
}

model MatchEvent {
  id             String         @id @default(cuid())
  matchId        String
  playerId       String?
  type           MatchEventType
  minute         Int
  additionalInfo String?

  match  Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([matchId])
  @@index([playerId])
  @@index([minute])
  @@map("match_events")
}

model MatchStats {
  id      String @id @default(cuid())
  matchId String @unique

  homeTeamId        String
  homePossession    Int?
  homeShots         Int?
  homeShotsOnTarget Int?
  homePasses        Int?
  homePassAccuracy  Float?
  homeTackles       Int?
  homeFouls         Int?
  homeCorners       Int?

  awayTeamId        String
  awayPossession    Int?
  awayShots         Int?
  awayShotsOnTarget Int?
  awayPasses        Int?
  awayPassAccuracy  Float?
  awayTackles       Int?
  awayFouls         Int?
  awayCorners       Int?

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@map("match_stats")
}

// ============================================================================
// TRAINING MODELS
// ============================================================================

model TrainingSession {
  id       String   @id @default(cuid())
  teamId   String
  coachId  String
  date     DateTime
  duration Int
  location String?
  focus    String
  notes    String?  @db.Text

  team       Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  coach      Coach                @relation(fields: [coachId], references: [id])
  drills     SessionDrill[]
  attendance TrainingAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([coachId])
  @@index([date])
  @@map("training_sessions")
}

model Drill {
  id          String            @id @default(cuid())
  name        String
  description String            @db.Text
  duration    Int
  intensity   TrainingIntensity
  playerCount Int
  difficulty  String
  category    TrainingCategory

  sessions SessionDrill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("drills")
}

model SessionDrill {
  id                String @id @default(cuid())
  trainingSessionId String
  drillId           String
  order             Int

  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  drill           Drill           @relation(fields: [drillId], references: [id])

  @@unique([trainingSessionId, drillId])
  @@index([trainingSessionId])
  @@index([drillId])
  @@map("session_drills")
}

model TrainingAttendance {
  id                String           @id @default(cuid())
  trainingSessionId String
  playerId          String
  status            AttendanceStatus
  performanceRating Int?
  notes             String?

  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  player          Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([trainingSessionId, playerId])
  @@index([trainingSessionId])
  @@index([playerId])
  @@map("training_attendance")
}

// ============================================================================
// ðŸ†• NEW: COACH TIMESHEET & PAYMENT MODELS
// ============================================================================

model CoachTimesheet {
  id      String          @id @default(cuid())
  coachId String
  period  String // "WEEKLY", "MONTHLY"
  
  // Time period
  startDate DateTime
  endDate   DateTime
  
  // Hours breakdown
  trainingHours     Float  @default(0)
  matchHours        Float  @default(0)
  adminHours        Float  @default(0)
  otherHours        Float  @default(0)
  totalHours        Float  @default(0)
  
  // Financial
  hourlyRate        Float
  totalAmount       Float
  
  // Status tracking
  status            TimesheetStatus  @default(DRAFT)
  submittedAt       DateTime?
  reviewedBy        String? // Treasurer/Manager
  reviewedAt        DateTime?
  reviewNotes       String?  @db.Text
  approvedBy        String? // SuperAdmin/Treasurer
  approvedAt        DateTime?
  
  // Attachments
  attachments       String[] // URLs to supporting documents
  
  coach     Coach  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  approver  User?  @relation("TimesheetApprover", fields: [approvedBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("coach_timesheets")
}

model CoachPayment {
  id           String        @id @default(cuid())
  coachId      String
  timesheetId  String?
  amount       Float
  currency     String        @default("GBP")
  paymentType  PaymentType   @default(COACHING_FEE)
  status       PaymentStatus @default(PENDING)
  
  // Payment details
  paymentMethod    String? // BANK_TRANSFER, PAYPAL, etc.
  transactionId    String?
  invoiceNumber    String?
  invoiceUrl       String?
  
  // Tracking
  processedBy      String? // Treasurer who processed
  processedAt      DateTime?
  paidAt           DateTime?
  notes            String?  @db.Text
  
  coach     Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  processor User? @relation("PaymentProcessor", fields: [processedBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([status])
  @@index([paymentType])
  @@map("coach_payments")
}

// ============================================================================
// TACTICAL MODELS
// ============================================================================

model Tactic {
  id             String    @id @default(cuid())
  coachId        String
  teamId         String
  name           String
  formation      Formation
  description    String?   @db.Text
  playStyle      String    @default("BALANCED")
  defensiveShape String    @default("COMPACT")
  pressType      String    @default("MID_BLOCK")

  coach           Coach          @relation(fields: [coachId], references: [id])
  team            Team           @relation(fields: [teamId], references: [id])
  playerPositions TacticPlayer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([teamId])
  @@map("tactics")
}

model TacticPlayer {
  id       String   @id @default(cuid())
  tacticId String
  playerId String
  position Position
  role     String?

  tactic Tactic @relation(fields: [tacticId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([tacticId, playerId])
  @@index([tacticId])
  @@index([playerId])
  @@map("tactic_players")
}

// ============================================================================
// PAYMENT & SUBSCRIPTION MODELS
// ============================================================================

model Subscription {
  id     String             @id @default(cuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  monthlyPrice   Float?
  annualDiscount Boolean @default(false)
  customPrice    Float?
  grantedByAdmin Boolean @default(false)
  grantedBy      String?
  grantReason    String?

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?
  trialEndsAt        DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(cuid())
  subscriptionId String?
  userId         String
  amount         Float
  currency       String        @default("GBP")
  status         PaymentStatus @default(PENDING)
  paymentType    PaymentType   @default(SUBSCRIPTION)

  stripePaymentIntentId String? @unique
  stripeInvoiceId       String?
  invoiceUrl            String?

  refundedBy   String?
  refundReason String?

  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([paymentType])
  @@map("payments")
}

// ============================================================================
// GAMIFICATION MODELS
// ============================================================================

model Achievement {
  id          String  @id @default(cuid())
  name        String  @unique
  description String  @db.Text
  icon        String?
  criterion   String
  threshold   Int
  points      Int     @default(10)

  playerAchievements PlayerAchievement[]

  @@index([criterion])
  @@map("achievements")
}

model PlayerAchievement {
  id            String   @id @default(cuid())
  playerId      String
  achievementId String
  unlockedAt    DateTime @default(now())

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([playerId, achievementId])
  @@index([playerId])
  @@index([achievementId])
  @@map("player_achievements")
}

model Leaderboard {
  id       String  @id @default(cuid())
  leagueId String?
  teamId   String?
  type     String
  season   Int

  @@index([leagueId])
  @@index([teamId])
  @@index([type])
  @@index([season])
  @@map("leaderboards")
}

// ============================================================================
// SCOUTING MODELS
// ============================================================================

model ScoutingProfile {
  id               String   @id @default(cuid())
  playerId         String
  createdBy        String
  rating           Int
  strengths        String[]
  weaknesses       String[]
  potential        Int
  notes            String?  @db.Text
  videoLinks       String[]
  comparablePlayer String?

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  scout  User   @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([playerId])
  @@index([createdBy])
  @@index([rating])
  @@map("scouting_profiles")
}

// ============================================================================
// COMMUNICATION MODELS
// ============================================================================

model Message {
  id            String  @id @default(cuid())
  teamId        String?
  senderId      String
  content       String  @db.Text
  attachmentUrl String?

  sender     User               @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipients MessageRecipient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model MessageRecipient {
  id          String    @id @default(cuid())
  messageId   String
  recipientId String
  readAt      DateTime?

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, recipientId])
  @@index([messageId])
  @@index([recipientId])
  @@map("message_recipients")
}

// ============================================================================
// NOTIFICATION MODELS
// ============================================================================

model Notification {
  id       String           @id @default(cuid())
  userId   String
  type     NotificationType
  title    String
  message  String
  link     String?
  read     Boolean          @default(false)
  metadata Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// PARENT/GUARDIAN MODELS
// ============================================================================

model Parent {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("parents")
}

// ============================================================================
// AUDIT LOG MODELS
// ============================================================================

model AuditLog {
  id            String      @id @default(cuid())
  performedBy   String?
  affectedUser  String?
  action        AuditAction
  entityType    String
  entityId      String
  changes       Json?
  previousValue Json?
  newValue      Json?
  reason        String?
  ipAddress     String?
  userAgent     String?

  performer User? @relation("AuditPerformer", fields: [performedBy], references: [id], onDelete: SetNull)
  affected  User? @relation("AuditUser", fields: [affectedUser], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([performedBy])
  @@index([affectedUser])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}
