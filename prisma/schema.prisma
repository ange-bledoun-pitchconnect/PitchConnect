// ============================================================================
// üåü PITCHCONNECT DATABASE SCHEMA v7.0.0 - ENTERPRISE GRADE (ENHANCED)
// ============================================================================
// Production-Ready | Multi-Tenant | GDPR-Compliant | Audit-Ready
// Technology: Next.js 15 | NextAuth v5 | Prisma 5.22.0+ | PostgreSQL 14+
// 
// ENHANCEMENTS IN v7.0.0:
// - Added Chat model for proper message relations
// - Made TeamPlayer.playerId required
// - Made LeagueTeam.teamId required (teams compete in leagues)
// - Added Season model for historical tracking
// - Added Transfer/Loan tracking for players
// - Added Medical Records model
// - Added Venue/Facility management
// - Added Match Officials (linesmen, VAR, etc.)
// - Added Tournament Bracket support
// - Added Training Attendance tracking
// - Added Player Availability Windows
// - Added Performance Goals/Targets
// - Added Team Announcements
// - Added Sponsor Management
// - Added Enhanced Video/Media handling
// - Additional indexes for performance optimization
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "driverAdapters", "views", "postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-1.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// üìã ENUMS - COMPLETE SYSTEM
// ============================================================================

enum UserRole {
  SUPERADMIN
  ADMIN
  PLAYER
  PLAYER_PRO
  COACH
  COACH_PRO
  MANAGER
  CLUB_MANAGER
  CLUB_OWNER
  TREASURER
  REFEREE
  SCOUT
  ANALYST
  PARENT
  LEAGUE_ADMIN
  MEDICAL_STAFF
  MEDIA_MANAGER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
  PENDING_EMAIL_VERIFICATION
  PENDING_PHONE_VERIFICATION
  ARCHIVED
  DELETED
}

enum UserType {
  INDIVIDUAL
  ORGANIZATION
  FAMILY
}

enum AccountTier {
  FREE
  PRO
  PREMIUM
  ENTERPRISE
}

enum OrganisationRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum OrganisationTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum PermissionType {
  // User management
  USER_CREATE
  USER_READ
  USER_UPDATE
  USER_DELETE
  USER_SUSPEND
  USER_BAN

  // Team management
  TEAM_CREATE
  TEAM_READ
  TEAM_UPDATE
  TEAM_DELETE
  TEAM_INVITE
  TEAM_REMOVE_MEMBER

  // Match management
  MATCH_CREATE
  MATCH_READ
  MATCH_UPDATE
  MATCH_DELETE
  MATCH_PUBLISH
  MATCH_APPROVE_RESULT
  MATCH_RECORD_STATS

  // Player management
  PLAYER_CREATE
  PLAYER_READ
  PLAYER_UPDATE
  PLAYER_DELETE
  PLAYER_VERIFY
  PLAYER_TRANSFER

  // Medical
  MEDICAL_READ
  MEDICAL_CREATE
  MEDICAL_UPDATE

  // Billing
  BILLING_READ
  BILLING_UPDATE
  BILLING_MANAGE_SUBSCRIPTIONS

  // Analytics
  ANALYTICS_VIEW
  ANALYTICS_EXPORT

  // API access
  API_ACCESS
  API_KEY_CREATE
  API_KEY_REVOKE

  // Facilities
  FACILITY_MANAGE
  FACILITY_BOOK

  // System
  SYSTEM_ADMIN
  AUDIT_LOG_VIEW
}

enum DataRetentionPolicy {
  EPHEMERAL // 7 days
  TEMPORARY // 30 days
  STANDARD // 7 years (default)
  PERMANENT // Forever
  DELETED // Marked for deletion
}

enum Sport {
  FOOTBALL
  NETBALL
  RUGBY
  CRICKET
  AMERICAN_FOOTBALL
  BASKETBALL
  HOCKEY
  LACROSSE
  AUSTRALIAN_RULES
  GAELIC_FOOTBALL
  FUTSAL
  BEACH_FOOTBALL
}

enum Position {
  // Football/Soccer (16 positions)
  GOALKEEPER
  LEFT_BACK
  CENTER_BACK
  RIGHT_BACK
  LEFT_WING_BACK
  RIGHT_WING_BACK
  DEFENSIVE_MIDFIELDER
  CENTRAL_MIDFIELDER
  LEFT_MIDFIELDER
  RIGHT_MIDFIELDER
  ATTACKING_MIDFIELDER
  LEFT_WINGER
  RIGHT_WINGER
  STRIKER
  CENTER_FORWARD
  SECOND_STRIKER

  // Netball (7 positions)
  GOALKEEPER_NETBALL
  GOAL_ATTACK
  WING_ATTACK
  CENTER
  WING_DEFENSE
  GOAL_DEFENSE
  GOAL_SHOOTER

  // Rugby Union (15 positions)
  PROP
  HOOKER
  LOCK
  FLANKER
  NUMBER_8
  SCRUM_HALF
  FLY_HALF
  INSIDE_CENTER
  OUTSIDE_CENTER
  FULLBACK

  // Rugby League
  HOOKER_LEAGUE
  PROP_LEAGUE
  SECOND_ROW
  LOOSE_FORWARD

  // American Football
  QUARTERBACK
  RUNNING_BACK
  WIDE_RECEIVER
  TIGHT_END
  LEFT_TACKLE
  LEFT_GUARD
  CENTER_POSITION
  RIGHT_GUARD
  RIGHT_TACKLE
  LINEBACKER
  DEFENSIVE_END
  DEFENSIVE_TACKLE
  SAFETY
  CORNERBACK
  PUNTER
  KICKER

  // Basketball
  POINT_GUARD
  SHOOTING_GUARD
  SMALL_FORWARD
  POWER_FORWARD
  CENTER_BASKETBALL

  // Cricket
  BATSMAN
  BOWLER
  ALL_ROUNDER
  FIELDER
  WICKET_KEEPER

  // Hockey
  GOALTENDER
  DEFENSEMAN
  WINGER
  CENTER_HOCKEY

  // Other
  UTILITY
  SUBSTITUTE
}

enum PreferredFoot {
  LEFT
  RIGHT
  BOTH
}

enum MatchStatus {
  SCHEDULED
  WARMUP
  LIVE
  HALFTIME
  SECOND_HALF
  EXTRA_TIME_FIRST
  EXTRA_TIME_SECOND
  PENALTIES
  FINISHED
  CANCELLED
  POSTPONED
  ABANDONED
  REPLAY_SCHEDULED
  VOIDED
  DELAYED
  SUSPENDED
}

enum MatchAttendanceStatus {
  AVAILABLE
  UNAVAILABLE
  CONFIRMED
  MAYBE
  LATE
  NO_SHOW
  EXCUSED_ABSENCE
  INJURED
  ILL
  SUSPENDED
  NOT_SELECTED
  SUBSTITUTE
  STARTING_LINEUP
  ATTENDED
  UNUSED_SUB
  UNUSED_SQUAD
  INTERNATIONAL_DUTY
  LOAN
}

enum MatchEventType {
  GOAL
  ASSIST
  YELLOW_CARD
  SECOND_YELLOW
  RED_CARD
  SUBSTITUTION_ON
  SUBSTITUTION_OFF
  INJURY
  INJURY_TIME
  FULLTIME
  HALFTIME
  KICKOFF
  PENALTY_SCORED
  PENALTY_MISSED
  PENALTY_SAVED
  OWN_GOAL
  VAR_REVIEW
  VAR_DECISION
  CHALLENGE_REVIEW
  TIMEOUT
  INTERCEPT
  REBOUND
  CENTER_PASS
  OBSTRUCTION
  TRY
  CONVERSION
  PENALTY_GOAL
  DROP_GOAL
  SCRUM
  LINEOUT
  MAUL
  RUCK
  KNOCK_ON
  HIGH_TACKLE
  OFFSIDE
  WICKET
  BOUNDARY
  MAIDEN_OVER
  WIDE
  NO_BALL
  BYE
  LEG_BYE
  OVERTHROW
  THREE_POINTER
  FAST_BREAK
  TURNOVER
  OFFENSIVE_FOUL
  TRAVEL
  DOUBLE_DRIBBLE
  TOUCHDOWN
  FIELD_GOAL
  SAFETY_SCORE
  INTERCEPTION
  FUMBLE
  SACK
  HAT_TRICK
  MAJOR_PENALTY
  MINOR_PENALTY
  FIGHT
  CAPTAIN_CHANGE
  WEATHER_DELAY
  FLOODLIGHT_FAILURE
}

enum FormationType {
  FOUR_FOUR_TWO
  FOUR_THREE_THREE
  THREE_FIVE_TWO
  FIVE_THREE_TWO
  FIVE_FOUR_ONE
  THREE_FOUR_THREE
  FOUR_TWO_THREE_ONE
  FOUR_ONE_FOUR_ONE
  THREE_THREE_FOUR
  FIVE_TWO_THREE
  TWO_THREE_FIVE
  FOUR_ONE_TWO_THREE
  FOUR_FOUR_ONE_ONE
  FOUR_THREE_TWO_ONE
  FOUR_FIVE_ONE
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
  PAST_DUE
  TRIAL
  SUSPENDED
  DOWNGRADED
  PENDING_UPGRADE
  PENDING_CANCELLATION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
  CANCELLED
  PROCESSING
  CHARGEBACK
}

enum WebhookEvent {
  MATCH_CREATED
  MATCH_STARTED
  MATCH_FINISHED
  MATCH_CANCELLED
  PLAYER_ADDED
  PLAYER_UPDATED
  PLAYER_INJURED
  PLAYER_TRANSFERRED
  TEAM_UPDATED
  SUBSCRIPTION_UPDATED
  PAYMENT_RECEIVED
  USER_CREATED
  USER_DELETED
  RESULT_APPROVED
  TRAINING_SCHEDULED
  ANNOUNCEMENT_POSTED
}

enum AuditActionType {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  ROLE_ASSIGNED
  SUBSCRIPTION_GRANTED
  SUBSCRIPTION_UPGRADED
  PAYMENT_PROCESSED
  DATA_EXPORTED
  DATA_DELETED
  TEAM_CREATED
  MATCH_CREATED
  MATCH_RESULT_UPDATED
  SYSTEM_MAINTENANCE
  API_KEY_GENERATED
  API_KEY_REVOKED
  LOGIN_ATTEMPT
  FAILED_LOGIN
  SUSPICIOUS_LOGIN
  PLAYER_TRANSFER
  MEDICAL_RECORD_ACCESSED
  CONSENT_UPDATED
}

enum TrainingIntensity {
  RECOVERY
  LOW
  MEDIUM
  HIGH
  MAXIMUM
  COMPETITIVE
}

enum TrainingCategory {
  PASSING
  SHOOTING
  DEFENDING
  POSSESSION
  SET_PIECES
  CONDITIONING
  TACTICAL
  RECOVERY
  STRENGTH_POWER
  SPEED_AGILITY
  FLEXIBILITY
  BALANCE_COORDINATION
  MENTAL_PREPARATION
  VIDEO_ANALYSIS
  TEAM_BUILDING
  GOALKEEPER_SPECIFIC
  POSITION_SPECIFIC
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
  LEFT_EARLY
  PARTIAL
}

enum LeagueFormat {
  ROUND_ROBIN
  DOUBLE_ROUND_ROBIN
  KNOCKOUT
  GROUP_KNOCKOUT
  ROUND_ROBIN_WITH_PLAYOFFS
  SWISS_SYSTEM
  LADDER_SYSTEM
  HOME_AND_AWAY
  CUSTOM
}

enum LeagueVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
  INVITE_ONLY
  FRIENDS_ONLY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  REVOKED
}

enum ResultApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
  REQUIRES_REVISION
  UNDER_REVIEW
  AUTO_APPROVED
}

enum ClubMemberRole {
  OWNER
  MANAGER
  HEAD_COACH
  ASSISTANT_COACH
  PLAYER
  STAFF
  TREASURER
  SCOUT
  ANALYST
  MEDICAL_STAFF
  PHYSIOTHERAPIST
  NUTRITIONIST
  PSYCHOLOGIST
  PERFORMANCE_COACH
  GOALKEEPING_COACH
  KIT_MANAGER
  MEDIA_OFFICER
}

enum TeamType {
  PROFESSIONAL
  SEMI_PROFESSIONAL
  AMATEUR
  ACADEMY
  YOUTH
  RECREATIONAL
  UNIVERSITY
  SCHOOL
}

enum VideoQuality {
  Q_360P
  Q_480P
  Q_720P
  Q_1080P
  Q_2K
  Q_4K
}

enum TranscodingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  QUEUED
}

enum VideoProcessingProvider {
  MUX
  AWS_MEDIACONVERT
  BUNNY_CDN
  CLOUDINARY
  INTERNAL
  VERCEL_BLOB
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PAID
  DISPUTED
  ARCHIVED
}

enum PaymentType {
  SUBSCRIPTION
  COACHING_FEE
  MATCH_FEE
  TOURNAMENT_FEE
  TRAINING_FEE
  FACILITY_RENTAL
  EQUIPMENT
  REFUND
  BONUS
  SALARY
  COMMISSION
  TRANSFER_FEE
  LOAN_FEE
  SPONSORSHIP
  OTHER
}

enum TransferType {
  PERMANENT
  LOAN
  FREE_TRANSFER
  YOUTH_DEVELOPMENT
  TRIAL
  EXCHANGE
}

enum TransferStatus {
  PENDING
  NEGOTIATING
  AGREED
  COMPLETED
  CANCELLED
  REJECTED
  EXPIRED
}

enum InjurySeverity {
  MINOR
  MODERATE
  SEVERE
  CRITICAL
  CAREER_THREATENING
}

enum InjuryStatus {
  ACTIVE
  RECOVERING
  REHABILITATION
  CLEARED
  CHRONIC
}

enum FacilityType {
  STADIUM
  TRAINING_GROUND
  INDOOR_ARENA
  GYM
  SWIMMING_POOL
  MEDICAL_CENTER
  MEETING_ROOM
  OFFICE
  CHANGING_ROOM
  HOSPITALITY
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ChatType {
  DIRECT
  GROUP
  TEAM
  CLUB
  ANNOUNCEMENT
}

enum MatchOfficialRole {
  REFEREE
  ASSISTANT_REFEREE_1
  ASSISTANT_REFEREE_2
  FOURTH_OFFICIAL
  VAR_OFFICIAL
  AVAR_OFFICIAL
  RESERVE_ASSISTANT
  MATCH_COMMISSIONER
  REFEREE_ASSESSOR
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AnnouncementStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum GoalType {
  PERFORMANCE
  DEVELOPMENT
  FITNESS
  BEHAVIORAL
  TEAM
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXCEEDED
  MISSED
  CANCELLED
}

// ============================================================================
// üè¢ ORGANISATION & MULTI-TENANCY MODELS
// ============================================================================

model Organisation {
  id   String @id @default(cuid())
  slug String @unique @db.VarChar(63)

  // Identity
  name        String
  description String? @db.Text
  logo        String?
  banner      String?
  website     String?

  // Contact & Location
  email    String
  phone    String?
  country  String
  timezone String  @default("Europe/London")

  // Business
  tier          OrganisationTier @default(STARTER)
  monthlyBudget Float?
  currency      String           @default("GBP")

  // Compliance
  registrationNumber      String?   @unique
  taxId                   String?   @unique
  complianceStatus        String    @default("PENDING")
  gdprCompliant           Boolean   @default(false)
  dataProcessingAgreement DateTime?

  // Usage tracking
  totalUsers    Int @default(0)
  totalTeams    Int @default(0)
  totalMatches  Int @default(0)
  storageUsedMb Int @default(0)

  // Feature access
  enabledFeatures String[] @default([])
  customFeatures  Json?

  // Quotas
  maxUsers            Int @default(100)
  maxTeams            Int @default(10)
  maxStorageMb        Int @default(5120)
  maxApiCallsPerMonth Int @default(10000)
  maxConcurrentUsers  Int @default(50)

  // Billing
  subscriptionId  String?   @unique
  billingEmail    String?
  billingCycle    String    @default("MONTHLY")
  nextBillingDate DateTime?

  // Activity & audit
  lastActivityAt DateTime?
  isActive       Boolean   @default(true)
  isArchived     Boolean   @default(false)
  archivedAt     DateTime?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  owner                User                     @relation("organisationOwner", fields: [ownerId], references: [id])
  ownerId              String
  members              OrganisationMember[]
  invitations          OrganisationInvitation[]
  clubs                Club[]
  apiKeys              ApiKey[]
  webhooks             Webhook[]
  auditLogs            AuditLog[]
  backups              DatabaseBackup[]
  subscriptions        Subscription[]
  dataExportRequests   DataExportRequest[]
  dataDeletionRequests DataDeletionRequest[]
  apiUsageMetrics      ApiUsageMetrics[]
  quotaUsage           QuotaUsage[]
  seasons              Season[]
  facilities           Facility[]
  sponsors             Sponsor[]
  mediaAssets          MediaAsset[]

  @@index([slug])
  @@index([ownerId])
  @@index([tier])
  @@index([isActive])
  @@index([createdAt])
  @@index([country])
  @@map("organisations")
}

model OrganisationMember {
  id             String  @id @default(cuid())
  organisationId String
  userId         String
  roleId         String?

  role OrganisationRole @default(MEMBER)

  // Permissions override
  customPermissions String[]

  // Activity
  joinedAt  DateTime  @default(now())
  invitedBy String?
  invitedAt DateTime?

  // Audit
  lastAccessAt DateTime?
  lastAccessIp String?

  // Soft delete
  removedAt DateTime?

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  customRole   Role?        @relation("roleMembers", fields: [roleId], references: [id], onDelete: SetNull)

  @@unique([organisationId, userId])
  @@index([organisationId])
  @@index([userId])
  @@index([roleId])
  @@index([role])
  @@index([joinedAt])
  @@map("organisation_members")
}

model OrganisationInvitation {
  id             String           @id @default(cuid())
  organisationId String
  email          String
  role           OrganisationRole @default(MEMBER)

  invitedBy String
  invitedAt DateTime @default(now())
  expiresAt DateTime

  acceptedAt DateTime?
  acceptedBy String?

  status InvitationStatus @default(PENDING)

  // Token for secure invitation link
  token String @unique @default(cuid())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, email])
  @@index([organisationId])
  @@index([status])
  @@index([token])
  @@index([expiresAt])
  @@map("organisation_invitations")
}

// ============================================================================
// üìÖ SEASON MODEL - NEW
// ============================================================================

model Season {
  id             String @id @default(cuid())
  organisationId String

  name      String // e.g., "2024/25"
  startDate DateTime
  endDate   DateTime

  isActive  Boolean @default(false)
  isCurrent Boolean @default(false)

  // Metadata
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  leagues      League[]
  transfers    Transfer[]

  @@unique([organisationId, name])
  @@index([organisationId])
  @@index([isActive])
  @@index([isCurrent])
  @@map("seasons")
}

// ============================================================================
// üë§ USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique @db.Citext
  emailVerified DateTime?
  phone         String?   @unique
  phoneVerified DateTime?

  // Profile
  firstName   String
  lastName    String
  middleName  String?
  displayName String?
  avatar      String?
  banner      String?
  bio         String?   @db.Text
  dateOfBirth DateTime?
  nationality String?
  language    String    @default("en-GB")
  timezone    String    @default("Europe/London")

  // Account
  userType    UserType    @default(INDIVIDUAL)
  accountTier AccountTier @default(FREE)
  roles       UserRole[]  @default([PLAYER])
  status      UserStatus  @default(PENDING_EMAIL_VERIFICATION)

  // Primary organisation context
  primaryOrganisationId String?

  // Auth
  password             String?
  passwordChangedAt    DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // 2FA & Security
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String?   @unique
  twoFactorBackupCodes String[]
  lastLoginAt          DateTime?
  lastLoginIp          String?
  loginAttempts        Int       @default(0)
  lockoutUntil         DateTime?

  // Preferences
  emailNotificationsEnabled Boolean @default(true)
  pushNotificationsEnabled  Boolean @default(true)
  smsNotificationsEnabled   Boolean @default(false)
  marketingEmailsEnabled    Boolean @default(false)
  privacyLevel              String  @default("FRIENDS_ONLY")
  showOnlineStatus          Boolean @default(true)
  profileVisibility         String  @default("PUBLIC")

  // Legal & Compliance
  gdprConsent             Boolean   @default(false)
  gdprConsentDate         DateTime?
  dataProcessingConsent   Boolean   @default(false)
  marketingConsent        Boolean   @default(false)
  cookieConsent           Boolean   @default(false)
  termsAcceptedAt         DateTime?
  privacyPolicyAcceptedAt DateTime?

  // Social
  followersCount Int @default(0)
  followingCount Int @default(0)

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Multi-org
  organisationMemberships OrganisationMember[]
  organisationsOwned      Organisation[]       @relation("organisationOwner")

  // Relations - Auth
  accounts      Account[]
  sessions      Session[]
  refreshTokens RefreshToken[]
  apiKeys       ApiKey[]

  // Relations - Roles
  player      Player?
  coach       Coach?
  referee     Referee?
  scout       Scout?
  analyst     Analyst?
  clubManager ClubManager?
  clubOwner   ClubOwner?
  parent      Parent?
  treasurer   Treasurer?

  // Relations - Clubs & Teams
  clubMemberships ClubMember[]
  managedClubs    Club[]       @relation("clubManager")
  ownedClubs      Club[]       @relation("clubOwner")

  // Relations - Communication
  notifications     Notification[]
  notificationPrefs NotificationPreference?
  messages          Message[]
  chatMembers       ChatMember[]
  chatsCreated      Chat[]                  @relation("chatCreator")

  // Relations - Social
  socialActions SocialAction[]
  followers     Follow[]       @relation("follower")
  following     Follow[]       @relation("following")
  blocks        UserBlock[]    @relation("blocker")
  blockedBy     UserBlock[]    @relation("blocked")

  // Relations - Gamification
  achievements Achievement[] @relation("achievementUser")
  badges       Badge[]       @relation("badgeUser")

  // Relations - Billing
  subscriptions Subscription[]
  payments      Payment[]
  invoices      Invoice[]

  // Relations - Audit
  auditLogsCreated AuditLog[] @relation("auditLogUser")

  // Relations - Announcements
  announcementsCreated Announcement[] @relation("announcementCreator")

  // Relations - Goals
  performanceGoals PerformanceGoal[] @relation("goalUser")
  goalsCreated     PerformanceGoal[] @relation("goalCreator")

  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([primaryOrganisationId])
  @@index([createdAt])
  @@index([lastName, firstName])
  @@map("users")
}

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token String? @db.Text
  access_token  String? @db.Text
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String? @db.Text
  session_state String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  ipAddress String?
  userAgent String?
  device    String?
  location  String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expires])
  @@map("sessions")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  usedAt    DateTime?

  // Security context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@map("refresh_tokens")
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  type       String   @default("EMAIL")
  expires    DateTime

  createdAt DateTime @default(now())

  @@unique([identifier, token])
  @@index([type])
  @@index([expires])
  @@map("verification_tokens")
}

model ApiKey {
  id             String  @id @default(cuid())
  userId         String
  organisationId String?

  name        String
  key         String    @unique @db.Char(32)
  secret      String?   @unique
  lastUsed    DateTime?
  expiresAt   DateTime?
  permissions String[]  @default([])

  // Rate limiting
  rateLimit      Int @default(1000)
  rateLimitReset Int @default(3600) // seconds

  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation Organisation? @relation(fields: [organisationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([key])
  @@index([organisationId])
  @@index([expiresAt])
  @@map("api_keys")
}

// ============================================================================
// üîê PERMISSION & ROLE MANAGEMENT - ENTERPRISE RBAC
// ============================================================================

model Role {
  id             String @id @default(cuid())
  organisationId String

  name        String
  slug        String
  description String? @db.Text

  // Classification
  isBuiltIn Boolean @default(false)
  isCustom  Boolean @default(true)
  level     Int     @default(0)

  // Permissions
  permissions          String[]
  customPermissionJson Json?

  // Usage
  memberCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisationMembers OrganisationMember[] @relation("roleMembers")

  @@unique([organisationId, slug])
  @@index([organisationId])
  @@index([level])
  @@map("roles")
}

model Permission {
  id String @id @default(cuid())

  type        PermissionType @unique
  description String?
  category    String

  @@index([category])
  @@map("permissions")
}

model ResourcePermission {
  id String @id @default(cuid())

  resourceType String
  resourceId   String

  userId     String
  permission String

  grantedAt DateTime  @default(now())
  grantedBy String
  expiresAt DateTime?

  @@unique([resourceType, resourceId, userId, permission])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([expiresAt])
  @@map("resource_permissions")
}

// ============================================================================
// üìã AUDIT, COMPLIANCE & DATA GOVERNANCE
// ============================================================================

model AuditLog {
  id             String  @id @default(cuid())
  organisationId String
  userId         String?

  action AuditActionType

  // Resource tracking
  resourceType String
  resourceId   String

  // What changed
  beforeState Json?
  afterState  Json?
  changes     String[]

  // Context
  ipAddress String?
  userAgent String?
  sessionId String?
  requestId String?

  // Metadata
  severity        String  @default("INFO")
  isCompliance    Boolean @default(false)
  requiresReview  Boolean @default(false)
  isLegalHold     Boolean @default(false)
  legalHoldReason String?

  // Performance tracking
  durationMs Int?

  createdAt DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user         User?        @relation("auditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([organisationId])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([severity])
  @@index([isCompliance])
  @@map("audit_logs")
}

model EntityVersion {
  id String @id @default(cuid())

  entityType String
  entityId   String
  version    Int

  // Complete snapshot
  data Json

  // Change metadata
  changedBy    String
  changeReason String?
  changeType   String

  // Checksum for integrity
  checksum String?

  // Retention policy
  retentionPolicy     DataRetentionPolicy @default(STANDARD)
  deletionScheduledAt DateTime?
  deletedAt           DateTime?

  createdAt DateTime @default(now())

  @@unique([entityType, entityId, version])
  @@index([entityType, entityId])
  @@index([deletionScheduledAt])
  @@index([retentionPolicy])
  @@map("entity_versions")
}

model ConsentLog {
  id     String @id @default(cuid())
  userId String

  type String

  granted   Boolean
  grantedAt DateTime

  // Evidence for compliance
  evidence  Json?
  ipAddress String?
  userAgent String?

  // Withdrawal tracking
  withdrawnAt DateTime?

  @@index([userId])
  @@index([type])
  @@index([grantedAt])
  @@map("consent_logs")
}

model DataExportRequest {
  id             String @id @default(cuid())
  userId         String
  organisationId String

  status String @default("PENDING")

  requestedAt DateTime  @default(now())
  processedAt DateTime?
  expiresAt   DateTime

  fileUrl  String?
  fileSize Int?
  format   String  @default("JSON")

  // Progress tracking
  progress Int @default(0)
  error    String?

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("data_export_requests")
}

model DataDeletionRequest {
  id             String @id @default(cuid())
  userId         String
  organisationId String

  reason      String?
  requestedAt DateTime @default(now())

  status      String    @default("PENDING")
  approvedAt  DateTime?
  completedAt DateTime?

  verificationToken  String?   @unique
  verificationSentAt DateTime?

  // Deletion details
  dataCategories String[]
  retainedData   String[]

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("data_deletion_requests")
}

// ============================================================================
// üèÉ PLAYER MODELS - ENHANCED FOR ANALYTICS
// ============================================================================

model Player {
  id     String @id @default(cuid())
  userId String @unique

  // Physical attributes
  height            Float?
  weight            Float?
  dateOfBirth       DateTime?
  nationality       String?
  secondNationality String?

  // Football specifics
  jerseyNumber      Int?
  preferredFoot     PreferredFoot?
  primaryPosition   Position?
  secondaryPosition Position?
  tertiaryPosition  Position?

  // Market & contract
  marketValue      Float?
  valueLastUpdated DateTime?
  currency         String    @default("GBP")

  // Status
  isActive            Boolean @default(true)
  isVerified          Boolean @default(false)
  hasCompletedProfile Boolean @default(false)
  isAcademy           Boolean @default(false)
  isYouth             Boolean @default(false)
  youthCategory       String?

  // Ratings & performance
  overallRating    Float?    @default(0)
  formRating       Float?    @default(0)
  developmentPhase String?
  fitnessLevel     Float?
  injuryStatus     String?
  lastFitnessTest  DateTime?

  // Availability
  availabilityStatus String @default("AVAILABLE")

  // Soft delete
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  statistics         PlayerStatistic[]
  aggregateStats     PlayerAggregateStats?
  analytics          PlayerAnalytic?         @relation("playerAnalytics")
  insights           PlayerInsight?          @relation("playerInsights")
  contracts          Contract[]
  injuries           Injury[]
  medicalRecords     MedicalRecord[]
  matchAttendance    MatchAttendance[]
  familyLinks        PlayerFamily[]
  scoutingReports    ScoutingReport[]
  highlights         PlayerHighlight[]
  badges             Badge[]                 @relation("badgePlayer")
  achievements       Achievement[]           @relation("achievementPlayer")
  transfersFrom      Transfer[]              @relation("transferFrom")
  transfersTo        Transfer[]              @relation("transferTo")
  availabilityWindow PlayerAvailability[]
  performanceGoals   PerformanceGoal[]       @relation("goalPlayer")
  trainingAttendance TrainingAttendance[]
  teamPlayers        TeamPlayer[]

  @@index([userId])
  @@index([isActive])
  @@index([isVerified])
  @@index([primaryPosition])
  @@index([marketValue])
  @@index([createdAt])
  @@index([availabilityStatus])
  @@map("players")
}

model PlayerStatistic {
  id       String  @id @default(cuid())
  playerId String
  season   Int
  teamId   String?
  leagueId String?

  // Core stats
  matches       Int @default(0)
  starts        Int @default(0)
  minutesPlayed Int @default(0)
  goals         Int @default(0)
  assists       Int @default(0)
  ownGoals      Int @default(0)

  // Disciplinary
  yellowCards   Int @default(0)
  secondYellows Int @default(0)
  redCards      Int @default(0)
  foulsCommited Int @default(0)
  foulsSuffered Int @default(0)

  // Technical
  passes          Int    @default(0)
  passAccuracy    Float?
  keyPasses       Int    @default(0)
  tackles         Int    @default(0)
  tackleSuccess   Float?
  interceptions   Int    @default(0)
  clearances      Int    @default(0)
  blocks          Int    @default(0)
  aerialDuelsWon  Int    @default(0)
  aerialDuelsLost Int    @default(0)

  // Shooting
  shots         Int    @default(0)
  shotsOnTarget Int    @default(0)
  shotAccuracy  Float?

  // Goalkeeper specific
  cleanSheets   Int    @default(0)
  saves         Int    @default(0)
  savePercent   Float?
  goalsConceded Int    @default(0)
  penaltySaves  Int    @default(0)

  // Dribbling
  dribbles        Int    @default(0)
  dribbleSuccess  Float?
  crossesAttempt  Int    @default(0)
  crossesComplete Int    @default(0)

  // Sport-specific
  sportSpecificStats Json?

  // Ratings
  averageRating Float?
  highestRating Float?
  lowestRating  Float?

  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season, teamId, leagueId])
  @@index([playerId])
  @@index([season])
  @@index([teamId])
  @@index([leagueId])
  @@map("player_statistics")
}

model PlayerAggregateStats {
  id       String @id @default(cuid())
  playerId String @unique

  // Career totals
  totalMatches     Int @default(0)
  totalStarts      Int @default(0)
  totalGoals       Int @default(0)
  totalAssists     Int @default(0)
  totalMinutes     Int @default(0)
  totalYellowCards Int @default(0)
  totalRedCards    Int @default(0)
  totalCleanSheets Int @default(0)

  // Averages
  avgGoalsPerMatch   Float @default(0)
  avgAssistsPerMatch Float @default(0)
  avgMinutesPerMatch Float @default(0)
  avgRating          Float @default(0)

  // Season current
  seasonGoals   Int @default(0)
  seasonAssists Int @default(0)
  seasonMatches Int @default(0)

  // Form (last 5 matches)
  formGoals   Int    @default(0)
  formAssists Int    @default(0)
  formRating  Float?

  // Rankings
  positionRank Int?
  leagueRank   Int?
  clubRank     Int?

  // Milestones
  milestone100Matches  DateTime?
  milestone50Goals     DateTime?
  milestone100Goals    DateTime?

  lastUpdatedAt DateTime @default(now())
  refreshedAt   DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([lastUpdatedAt])
  @@map("player_aggregate_stats")
}

model PlayerAnalytic {
  id       String @id @default(cuid())
  playerId String @unique

  // Ratings
  overallRating        Float @default(0)
  formRating           Float @default(0)
  consistencyIndex     Float @default(0)
  injuryRisk           Float @default(0)
  developmentPotential Float @default(0)
  fatigueLevelEstimate Float @default(0)
  workRateIndex        Float @default(0)

  // Rankings
  positionRank Int?
  leagueRank   Int?
  globalRank   Int?
  ageGroupRank Int?

  // Trends
  weeklyTrend  Float?
  monthlyTrend Float?
  seasonTrend  Float?

  // Performance
  lastMatchRating  Float?
  last5MatchesAvg  Float?
  last10MatchesAvg Float?
  seasonAverage    Float?

  // Predictions
  predictions          Json?
  predictionConfidence Float?

  // Advanced metrics
  expectedGoals       Float?
  expectedAssists     Float?
  passCompletionTrend Float?
  pressureIndex       Float?
  tacticalAwareness   Float?

  // Development
  strengths        String[]
  weaknesses       String[]
  developmentAreas String[]
  recommendations  String?   @db.Text
  lastAnalysisDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation("playerAnalytics", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([overallRating])
  @@index([injuryRisk])
  @@index([formRating])
  @@map("player_analytics")
}

model PlayerInsight {
  id       String @id @default(cuid())
  playerId String @unique

  // Analysis
  strengths        String[]
  weaknesses       String[]
  developmentAreas String[]
  playingStyle     String?
  strongFoot       String?
  comparablePlayers String[] // Similar player profiles

  // Attributes (0-100 scale)
  pace                 Int?
  shooting             Int?
  passing              Int?
  dribbling            Int?
  defending            Int?
  physical             Int?
  aggressiveness       Int?
  defensiveAbility     Int?
  leadership           Int?
  teamwork             Int?
  situationalAwareness Int?
  composure            Int?
  creativity           Int?
  workRate             Int?

  // Mental attributes
  determination Int?
  concentration Int?
  decisions     Int?
  anticipation  Int?
  vision        Int?

  // Guidance
  recommendations String?   @db.Text
  careerAdvice    String?   @db.Text
  lastReviewDate  DateTime?
  reviewedBy      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation("playerInsights", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@map("player_insights")
}

model PlayerFamily {
  id           String  @id @default(cuid())
  playerId     String
  parentId     String?
  guardianId   String?
  relationship String

  // Emergency contact info
  isEmergencyContact Boolean @default(false)
  phone              String?
  email              String?

  // Permissions
  canViewMedical Boolean @default(false)
  canSignForms   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([parentId])
  @@map("player_family")
}

model PlayerHighlight {
  id       String  @id @default(cuid())
  playerId String
  matchId  String?

  title         String
  description   String? @db.Text
  videoUrl      String?
  thumbnailUrl  String?
  duration      Int?
  highlightType String

  // Processing status
  processingStatus TranscodingStatus @default(PENDING)

  // Engagement
  viewCount Int @default(0)
  likeCount Int @default(0)

  // Visibility
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([matchId])
  @@index([isFeatured])
  @@map("player_highlights")
}

model PlayerAvailability {
  id       String @id @default(cuid())
  playerId String

  startDate DateTime
  endDate   DateTime

  reason String // e.g., "International duty", "Personal", "Vacation"
  status MatchAttendanceStatus

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([startDate, endDate])
  @@map("player_availability")
}

model Injury {
  id       String @id @default(cuid())
  playerId String

  type     String
  severity InjurySeverity @default(MINOR)
  location String // Body part

  dateFrom        DateTime
  dateTo          DateTime?
  estimatedReturn DateTime?
  actualReturn    DateTime?

  description String? @db.Text
  treatment   String?
  therapist   String?
  status      InjuryStatus @default(ACTIVE)

  // Medical details
  diagnosedBy String?
  facility    String?
  scans       String[]
  notes       String? @db.Text

  // Recovery tracking
  recoveryProgress Int? // Percentage
  lastAssessment   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([dateFrom])
  @@index([status])
  @@index([severity])
  @@map("injuries")
}

// ============================================================================
// üè• MEDICAL RECORDS - NEW
// ============================================================================

model MedicalRecord {
  id       String @id @default(cuid())
  playerId String

  recordType String // e.g., "Physical", "Vaccination", "Blood Test", "Cardiac Screening"
  date       DateTime

  // Details
  results     Json?
  notes       String?  @db.Text
  provider    String?
  facility    String?
  attachments String[]

  // Fitness clearance
  isClearanceRecord Boolean @default(false)
  clearanceStatus   String?
  clearanceExpiry   DateTime?

  // Compliance
  isConfidential  Boolean @default(true)
  accessRestricted Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([recordType])
  @@index([date])
  @@map("medical_records")
}

model Contract {
  id       String  @id @default(cuid())
  playerId String
  clubId   String?

  position Position

  // Financial
  salary           Float?
  currency         String @default("GBP")
  bonusStructure   Json?
  performanceBonus Float?
  signOnBonus      Float?
  loyaltyBonus     Float?
  appearanceFee    Float?
  goalBonus        Float?

  // Dates
  startDate DateTime
  endDate   DateTime?

  // Terms
  contractType     String  @default("PROFESSIONAL")
  status           String  @default("ACTIVE")
  contractDocument String?

  // Extensions & clauses
  extensionOption Boolean   @default(false)
  extensionDate   DateTime?
  extensionYears  Int?
  buyoutClause    Float?
  releaseClause   Float?
  matchingRights  Boolean   @default(false)

  // Image rights
  imageRightsPercent Float?

  // Agent
  agentName       String?
  agentEmail      String?
  agentPhone      String?
  agentCommission Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([clubId])
  @@index([status])
  @@index([endDate])
  @@map("contracts")
}

// ============================================================================
// üîÑ TRANSFER & LOAN SYSTEM - NEW
// ============================================================================

model Transfer {
  id String @id @default(cuid())

  playerId    String
  fromClubId  String?
  toClubId    String?
  seasonId    String?

  type   TransferType
  status TransferStatus @default(PENDING)

  // Financial
  fee              Float?
  feeType          String   @default("FIXED") // FIXED, RISING, UNDISCLOSED
  currency         String   @default("GBP")
  addOns           Json? // Performance-based add-ons
  sellOnPercent    Float? // % of future sale
  installments     Json? // Payment schedule
  agentFee         Float?

  // Loan specific
  loanFee          Float?
  wageContribution Float? // % of wages paid by parent club
  buyOption        Float?
  buyObligation    Float?
  recallClause     Boolean @default(false)

  // Dates
  announcedAt   DateTime?
  completedAt   DateTime?
  effectiveDate DateTime
  loanEndDate   DateTime?

  // Documentation
  medicalPassed  Boolean   @default(false)
  medicalDate    DateTime?
  contractSigned Boolean   @default(false)
  contractDate   DateTime?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player     Player  @relation("transferFrom", fields: [playerId], references: [id], onDelete: Cascade)
  toPlayer   Player? @relation("transferTo", fields: [playerId], references: [id], onDelete: Cascade, map: "transfer_to_player")
  season     Season? @relation(fields: [seasonId], references: [id], onDelete: SetNull)

  @@index([playerId])
  @@index([fromClubId])
  @@index([toClubId])
  @@index([status])
  @@index([effectiveDate])
  @@map("transfers")
}

// ============================================================================
// üèÜ COACH MODELS - ENHANCED FOR PAYMENTS & TIMESHEETS
// ============================================================================

model Coach {
  id     String @id @default(cuid())
  userId String @unique

  // Professional details
  coachType       String   @default("HEAD_COACH")
  specialization  String[]
  certifications  String[]
  yearsExperience Int?
  qualifications  String[] @db.Text
  bio             String?  @db.Text

  // Payment & contract
  hourlyRate   Float?
  dailyRate    Float?
  currency     String  @default("GBP")
  bankDetails  Json?
  taxId        String?
  contractType String?

  // Verification
  isVerified            Boolean   @default(false)
  verificationDate      DateTime?
  licenseNumber         String?   @unique
  licenseExpiry         DateTime?
  backgroundCheckExpiry DateTime?
  dbsCheckNumber        String?
  dbsCheckExpiry        DateTime?
  safeguardingExpiry    DateTime?
  firstAidExpiry        DateTime?

  // Performance metrics
  overallRating       Float? @default(0)
  totalPlayersCoached Int    @default(0)
  successRate         Float?
  matchesManaged      Int    @default(0)
  winRate             Float?

  // Availability
  isAvailable       Boolean @default(true)
  availabilityNotes String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  clubMemberships  ClubMember[]      @relation("coachMemberships")
  trainingSessions TrainingSession[]
  timesheets       CoachTimesheet[]  @relation("coach")
  payments         CoachPayment[]
  achievements     Achievement[]     @relation("achievementCoach")

  @@index([userId])
  @@index([isVerified])
  @@index([coachType])
  @@index([licenseExpiry])
  @@map("coaches")
}

model CoachTimesheet {
  id      String  @id @default(cuid())
  coachId String
  clubId  String?

  weekStartDate DateTime
  weekEndDate   DateTime

  totalHours  Float   @default(0)
  hourlyRate  Float?
  hourlyCost  Float?
  totalCost   Float?

  description String?  @db.Text
  attachments String[]

  // Breakdown by activity
  breakdown Json? // { training: 10, matches: 5, admin: 2 }

  status          TimesheetStatus @default(DRAFT)
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  paidAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach Coach @relation("coach", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([clubId])
  @@index([status])
  @@index([weekStartDate])
  @@map("coach_timesheets")
}

model CoachPayment {
  id      String @id @default(cuid())
  coachId String

  amount        Float
  currency      String   @default("GBP")
  paymentDate   DateTime
  paymentMethod String

  invoiceNumber String? @unique
  reference     String?
  timesheetId   String?

  status      PaymentStatus @default(PENDING)
  description String?

  // Tax info
  taxAmount Float?
  netAmount Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([status])
  @@index([paymentDate])
  @@map("coach_payments")
}

// ============================================================================
// ü§ù OTHER STAFF MODELS
// ============================================================================

model Referee {
  id     String @id @default(cuid())
  userId String @unique

  licenseNumber     String?  @unique
  licenseLevel      String?
  yearsOfExperience Int?
  specialization    String[]

  certificationDate     DateTime?
  certificationExpiry   DateTime?
  backgroundCheckExpiry DateTime?
  fitnessTestDate       DateTime?
  fitnessTestExpiry     DateTime?

  assignedMatches Int     @default(0)
  isVerified      Boolean @default(false)
  isActive        Boolean @default(true)

  // Ratings
  averageRating Float?
  totalReviews  Int   @default(0)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchOfficials MatchOfficial[]

  @@index([userId])
  @@index([isVerified])
  @@index([licenseLevel])
  @@map("referees")
}

model Scout {
  id     String @id @default(cuid())
  userId String @unique

  specialization  String[]
  region          String?
  regions         String[]
  yearsExperience Int?
  focusAgeGroup   String?
  focusPositions  Position[]

  isVerified Boolean @default(false)
  isActive   Boolean @default(true)

  // Performance
  playersRecommended Int @default(0)
  playersSigned      Int @default(0)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scoutingReports ScoutingReport[]

  @@index([userId])
  @@index([isVerified])
  @@index([region])
  @@map("scouts")
}

model Analyst {
  id     String @id @default(cuid())
  userId String @unique

  specialization  String[]
  tools           String[]
  yearsExperience Int?

  isVerified Boolean @default(false)
  isActive   Boolean @default(true)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isVerified])
  @@map("analysts")
}

model ClubManager {
  id     String @id @default(cuid())
  userId String @unique

  managingStyle   String?
  yearsExperience Int?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("club_managers")
}

model ClubOwner {
  id     String @id @default(cuid())
  userId String @unique

  businessType    String?
  yearsInBusiness Int?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("club_owners")
}

model Parent {
  id     String @id @default(cuid())
  userId String @unique

  childrenCount Int @default(0)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("parents")
}

model Treasurer {
  id     String @id @default(cuid())
  userId String @unique

  yearsExperience Int?
  bankDetails     Json?
  qualifications  String[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("treasurers")
}

// ============================================================================
// üè¢ CLUB & TEAM MODELS
// ============================================================================

model Club {
  id             String  @id @default(cuid())
  organisationId String?
  name           String
  slug           String  @unique
  shortName      String? // e.g., "MUN" for Manchester United
  description    String? @db.Text
  logo           String?
  banner         String?
  website        String?
  email          String?
  phone          String?
  foundedYear    Int?

  // Location
  city          String?
  state         String?
  country       String?
  address       String?
  postcode      String?
  venue         String?
  venueCapacity Int?
  coordinates   Json? // { lat, lng }

  // Sport & type
  sport    Sport
  teamType TeamType @default(AMATEUR)

  // Management
  managerId String
  ownerId   String?

  // Colours
  primaryColor   String?
  secondaryColor String?

  // Status
  isVerified       Boolean @default(false)
  isPublic         Boolean @default(true)
  acceptingPlayers Boolean @default(true)

  // Metrics
  followerCount Int @default(0)
  joinedMembers Int @default(0)

  // Social
  twitter   String?
  facebook  String?
  instagram String?
  youtube   String?
  tiktok    String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation     Organisation?       @relation(fields: [organisationId], references: [id], onDelete: SetNull)
  manager          User                @relation("clubManager", fields: [managerId], references: [id])
  owner            User?               @relation("clubOwner", fields: [ownerId], references: [id])
  members          ClubMember[]
  teams            Team[]
  leagues          League[]
  formations       TeamFormation[]
  tactics          Tactic[]
  trainingSessions TrainingSession[]
  homeMatches      Match[]             @relation("homeTeam")
  awayMatches      Match[]             @relation("awayTeam")
  aggregateStats   TeamAggregateStats?
  announcements    Announcement[]
  sponsors         ClubSponsor[]

  @@index([organisationId])
  @@index([managerId])
  @@index([ownerId])
  @@index([sport])
  @@index([isPublic])
  @@index([city])
  @@index([country])
  @@map("clubs")
}

model ClubMember {
  id      String  @id @default(cuid())
  userId  String
  clubId  String
  coachId String?

  role ClubMemberRole @default(STAFF)

  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isActive  Boolean   @default(true)
  isCaptain Boolean   @default(false)

  salary       Float?
  currency     String  @default("GBP")
  contractEnd  DateTime?

  // Permissions
  canManageRoster  Boolean @default(false)
  canManageMatches Boolean @default(false)
  canManageBilling Boolean @default(false)

  deletedAt DateTime?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  club  Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coach Coach? @relation("coachMemberships", fields: [coachId], references: [id], onDelete: SetNull)

  @@unique([userId, clubId])
  @@index([userId])
  @@index([clubId])
  @@index([coachId])
  @@index([role])
  @@index([isActive])
  @@map("club_members")
}

model Team {
  id     String @id @default(cuid())
  clubId String

  name        String
  description String? @db.Text
  logo        String?
  ageGroup    String?
  gender      String? // MALE, FEMALE, MIXED

  // Capacity
  minPlayers Int?
  maxPlayers Int?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club        Club            @relation(fields: [clubId], references: [id], onDelete: Cascade)
  players     TeamPlayer[]
  matchSquads MatchSquad[]
  formations  TeamFormation[]
  leagueTeams LeagueTeam[]

  @@unique([clubId, name])
  @@index([clubId])
  @@index([ageGroup])
  @@map("teams")
}

model TeamPlayer {
  id       String @id @default(cuid())
  teamId   String
  playerId String // FIXED: Now required

  position     Position?
  jerseyNumber Int?
  isActive     Boolean   @default(true)
  isCaptain    Boolean   @default(false)
  isViceCaptain Boolean  @default(false)

  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@index([playerId])
  @@index([isActive])
  @@map("team_players")
}

model TeamFormation {
  id     String  @id @default(cuid())
  clubId String
  teamId String?

  name        String?
  formation   FormationType @default(FOUR_FOUR_TWO)
  description String?
  diagram     Json?

  // Player positions within formation
  positions Json? // { GK: "playerId", LB: "playerId", ... }

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club Club  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  team Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([clubId])
  @@index([teamId])
  @@map("team_formations")
}

// ============================================================================
// üèÜ LEAGUE & COMPETITION MODELS
// ============================================================================

model League {
  id       String  @id @default(cuid())
  clubId   String
  seasonId String?

  name        String
  description String? @db.Text
  season      Int

  startDate            DateTime
  endDate              DateTime?
  registrationDeadline DateTime?

  format     LeagueFormat     @default(ROUND_ROBIN)
  visibility LeagueVisibility @default(PRIVATE)
  status     String           @default("DRAFT")

  maxTeams        Int?
  teamsRegistered Int  @default(0)

  // Tiebreakers
  tiebreakers String[] @default(["GOAL_DIFFERENCE", "GOALS_FOR", "HEAD_TO_HEAD"])

  // Points system
  pointsForWin  Int @default(3)
  pointsForDraw Int @default(1)
  pointsForLoss Int @default(0)

  logo  String?
  rules String? @db.Text

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club           Club                  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  seasonRef      Season?               @relation(fields: [seasonId], references: [id], onDelete: SetNull)
  teams          LeagueTeam[]
  matches        Match[]
  standings      LeagueStanding[]
  aggregateStats LeagueAggregateStats?
  brackets       TournamentBracket[]

  @@index([clubId])
  @@index([seasonId])
  @@index([status])
  @@index([startDate])
  @@map("leagues")
}

model LeagueTeam {
  id       String @id @default(cuid())
  leagueId String
  teamId   String // FIXED: Now required

  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  isActive   Boolean   @default(true)
  seedNumber Int?

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([teamId])
  @@map("league_teams")
}

model LeagueStanding {
  id       String  @id @default(cuid())
  leagueId String
  teamId   String?

  position       Int
  played         Int @default(0)
  wins           Int @default(0)
  draws          Int @default(0)
  losses         Int @default(0)
  goalsFor       Int @default(0)
  goalsAgainst   Int @default(0)
  goalDifference Int @default(0)
  points         Int @default(0)

  // Form (last 5: W, D, L)
  form String?

  // Home/Away split
  homeWins   Int @default(0)
  homeDraws  Int @default(0)
  homeLosses Int @default(0)
  awayWins   Int @default(0)
  awayDraws  Int @default(0)
  awayLosses Int @default(0)

  updatedAt DateTime @updatedAt

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([position])
  @@map("league_standings")
}

model LeagueAggregateStats {
  id       String @id @default(cuid())
  leagueId String @unique

  totalMatches        Int   @default(0)
  completedMatches    Int   @default(0)
  totalGoals          Int   @default(0)
  avgGoalsPerMatch    Float @default(0)
  homeWins            Int   @default(0)
  awayWins            Int   @default(0)
  draws               Int   @default(0)
  totalYellowCards    Int   @default(0)
  totalRedCards       Int   @default(0)
  biggestWin          Json? // { home: 5, away: 0, matchId: "..." }
  highestScoringMatch Json? // { home: 4, away: 3, matchId: "..." }

  lastUpdatedAt DateTime @default(now())

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId])
  @@map("league_aggregate_stats")
}

// ============================================================================
// üèÜ TOURNAMENT BRACKET - NEW
// ============================================================================

model TournamentBracket {
  id       String @id @default(cuid())
  leagueId String

  round     Int // 1 = Final, 2 = Semi, 4 = Quarter, etc.
  position  Int // Position within the round
  matchId   String?

  // Teams
  homeTeamId   String?
  awayTeamId   String?
  homeScore    Int?
  awayScore    Int?
  winnerId     String?

  // Source (where teams come from)
  homeSourceBracketId String?
  awaySourceBracketId String?

  // Timing
  scheduledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, round, position])
  @@index([leagueId])
  @@index([round])
  @@map("tournament_brackets")
}

// ============================================================================
// ‚öΩ MATCH & EVENT MODELS
// ============================================================================

model Match {
  id         String  @id @default(cuid())
  leagueId   String?
  homeClubId String
  awayClubId String

  title       String?
  description String? @db.Text

  kickOffTime DateTime
  status      MatchStatus @default(SCHEDULED)

  venue     String?
  venueId   String?
  pitch     String? // e.g., "Pitch 1", "Main Stadium"

  // Weather conditions
  weather     String?
  temperature Int?

  // Score
  homeScore         Int?
  awayScore         Int?
  homeHalftimeScore Int?
  awayHalftimeScore Int?
  homePenalties     Int?
  awayPenalties     Int?

  // Extra time scores
  homeExtraTimeScore Int?
  awayExtraTimeScore Int?

  // Attendance
  attendance Int?
  capacity   Int?

  // Duration
  actualDuration   Int?
  injuryTimeFirst  Int?
  injuryTimeSecond Int?

  // Approval
  resultApprovalStatus ResultApprovalStatus @default(PENDING)
  approvedBy           String?
  approvedAt           DateTime?
  disputeReason        String?

  // Metadata
  isHighlighted Boolean @default(false)
  isFeatured    Boolean @default(false)
  isNeutralVenue Boolean @default(false)

  // Broadcast
  isBroadcasted Boolean @default(false)
  broadcastUrl  String?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league           League?           @relation(fields: [leagueId], references: [id], onDelete: SetNull)
  homeTeam         Club              @relation("homeTeam", fields: [homeClubId], references: [id])
  awayTeam         Club              @relation("awayTeam", fields: [awayClubId], references: [id])
  events           MatchEvent[]
  squads           MatchSquad[]
  playerAttendance MatchAttendance[]
  stats            MatchStat[]
  officials        MatchOfficial[]

  @@index([leagueId])
  @@index([homeClubId])
  @@index([awayClubId])
  @@index([status])
  @@index([kickOffTime])
  @@index([resultApprovalStatus])
  @@map("matches")
}

model MatchOfficial {
  id        String @id @default(cuid())
  matchId   String
  refereeId String

  role MatchOfficialRole

  // Ratings
  performanceRating Float?
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match   Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  referee Referee @relation(fields: [refereeId], references: [id], onDelete: Cascade)

  @@unique([matchId, role])
  @@index([matchId])
  @@index([refereeId])
  @@map("match_officials")
}

model MatchEvent {
  id       String  @id @default(cuid())
  matchId  String
  playerId String?

  eventType       MatchEventType
  minute          Int
  secondaryMinute Int? // For stoppage time
  period          String? // FIRST_HALF, SECOND_HALF, EXTRA_TIME, PENALTIES

  // For substitutions
  relatedPlayerId String? // Player coming off

  // For goals
  assistPlayerId String?
  goalType       String? // OPEN_PLAY, PENALTY, FREE_KICK, HEADER, OWN_GOAL

  // For cards
  cardReason String?

  details Json?
  videoTimestamp Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([eventType])
  @@index([playerId])
  @@index([minute])
  @@map("match_events")
}

model MatchSquad {
  id       String  @id @default(cuid())
  matchId  String
  teamId   String
  playerId String?

  lineupPosition Int?
  shirtNumber    Int?

  status MatchAttendanceStatus @default(NOT_SELECTED)

  // For substitutes
  substituteOrder Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([teamId])
  @@index([playerId])
  @@map("match_squads")
}

model MatchAttendance {
  id       String @id @default(cuid())
  matchId  String
  playerId String

  status          MatchAttendanceStatus @default(AVAILABLE)
  notesFromPlayer String?
  responseDate    DateTime?

  minutesPlayed Int?
  rating        Float?

  // Performance
  goals        Int @default(0)
  assists      Int @default(0)
  yellowCards  Int @default(0)
  redCard      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@index([status])
  @@map("match_attendance")
}

model MatchStat {
  id       String  @id @default(cuid())
  matchId  String
  playerId String?
  teamId   String?

  // Core stats
  goals         Int    @default(0)
  assists       Int    @default(0)
  minutesPlayed Int    @default(0)

  // Passing
  passes          Int    @default(0)
  passesComplete  Int    @default(0)
  passAccuracy    Float?
  keyPasses       Int    @default(0)
  longBalls       Int    @default(0)
  throughBalls    Int    @default(0)

  // Defensive
  tackles       Int @default(0)
  interceptions Int @default(0)
  clearances    Int @default(0)
  blocks        Int @default(0)

  // Attacking
  shots         Int @default(0)
  shotsOnTarget Int @default(0)
  dribbles      Int @default(0)
  crosses       Int @default(0)

  // Disciplinary
  fouls       Int @default(0)
  fouled      Int @default(0)
  yellowCards Int @default(0)
  redCards    Int @default(0)

  // Goalkeeper
  saves         Int @default(0)
  goalsConceded Int @default(0)
  cleanSheet    Boolean @default(false)

  // Aerial
  aerialsWon  Int @default(0)
  aerialsLost Int @default(0)

  // Possession
  touches    Int    @default(0)
  possession Float?

  // Rating
  rating Float?

  customStats Json?

  updatedAt DateTime @updatedAt

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([matchId, playerId, teamId])
  @@index([matchId])
  @@index([playerId])
  @@index([teamId])
  @@map("match_stats")
}

// ============================================================================
// üìä TRAINING MODELS - ENHANCED
// ============================================================================

model TrainingSession {
  id      String @id @default(cuid())
  clubId  String
  coachId String

  name        String
  description String? @db.Text

  startTime DateTime
  endTime   DateTime

  intensity TrainingIntensity @default(MEDIUM)
  category  TrainingCategory

  location        String?
  facilityId      String?
  maxParticipants Int?

  // Content
  drills    Json?
  notes     String? @db.Text
  equipment String[]

  // Status
  status String @default("SCHEDULED")

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club       Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coach      Coach                @relation(fields: [coachId], references: [id], onDelete: Cascade)
  attendance TrainingAttendance[]

  @@index([clubId])
  @@index([coachId])
  @@index([startTime])
  @@index([status])
  @@map("training_sessions")
}

model TrainingAttendance {
  id        String @id @default(cuid())
  sessionId String
  playerId  String

  status      AttendanceStatus @default(PRESENT)
  arrivalTime DateTime?
  notes       String?

  // Performance tracking
  performanceRating Float?
  effortRating      Float?
  coachNotes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  player  Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([sessionId, playerId])
  @@index([sessionId])
  @@index([playerId])
  @@index([status])
  @@map("training_attendance")
}

model ScoutingReport {
  id       String @id @default(cuid())
  scoutId  String
  playerId String

  rating       Float?
  observations String? @db.Text

  // Detailed ratings
  technicalRating Float?
  tacticalRating  Float?
  physicalRating  Float?
  mentalRating    Float?

  // Recommendation
  recommendation   String? // SIGN, MONITOR, REJECT
  urgency          String? // HIGH, MEDIUM, LOW
  suggestedValue   Float?
  currency         String  @default("GBP")

  // Match context
  matchWatched String?
  matchDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scout  Scout  @relation(fields: [scoutId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([scoutId])
  @@index([playerId])
  @@index([recommendation])
  @@map("scouting_reports")
}

model Tactic {
  id     String @id @default(cuid())
  clubId String

  name        String
  description String? @db.Text
  diagram     Json?
  formation   FormationType?

  // Instructions
  defendingStyle  String?
  attackingStyle  String?
  pressingTrigger String?
  buildUpPlay     String?

  // Set pieces
  corners     Json?
  freeKicks   Json?
  throwIns    Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([isActive])
  @@map("tactics")
}

model TeamAggregateStats {
  id     String @id @default(cuid())
  clubId String @unique

  // Overall
  totalMatches      Int @default(0)
  totalWins         Int @default(0)
  totalDraws        Int @default(0)
  totalLosses       Int @default(0)
  totalGoalsFor     Int @default(0)
  totalGoalsAgainst Int @default(0)
  winRate           Float?

  // Home
  homeMatches Int @default(0)
  homeWins    Int @default(0)
  homeDraws   Int @default(0)
  homeLosses  Int @default(0)

  // Away
  awayMatches Int @default(0)
  awayWins    Int @default(0)
  awayDraws   Int @default(0)
  awayLosses  Int @default(0)

  // Streaks
  currentStreak     Int    @default(0)
  streakType        String? // WIN, DRAW, LOSS, UNBEATEN
  longestWinStreak  Int    @default(0)
  longestLossStreak Int    @default(0)

  // Clean sheets
  cleanSheets Int @default(0)

  lastUpdatedAt DateTime @default(now())

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@map("team_aggregate_stats")
}

// ============================================================================
// üéØ PERFORMANCE GOALS - NEW
// ============================================================================

model PerformanceGoal {
  id String @id @default(cuid())

  userId   String?
  playerId String?

  type     GoalType
  title    String
  description String? @db.Text

  // Target
  targetValue  Float?
  currentValue Float?
  unit         String? // e.g., "goals", "km", "hours"

  // Dates
  startDate  DateTime
  endDate    DateTime
  status     GoalStatus @default(NOT_STARTED)

  // Progress
  progress   Int @default(0) // Percentage
  milestones Json?

  // Review
  reviewedAt DateTime?
  reviewedBy String?
  feedback   String? @db.Text

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User?   @relation("goalUser", fields: [userId], references: [id], onDelete: Cascade)
  player  Player? @relation("goalPlayer", fields: [playerId], references: [id], onDelete: Cascade)
  creator User    @relation("goalCreator", fields: [createdBy], references: [id])

  @@index([userId])
  @@index([playerId])
  @@index([status])
  @@index([type])
  @@map("performance_goals")
}

// ============================================================================
// üèüÔ∏è FACILITY MANAGEMENT - NEW
// ============================================================================

model Facility {
  id             String @id @default(cuid())
  organisationId String

  name        String
  type        FacilityType
  description String? @db.Text

  // Location
  address   String?
  city      String?
  postcode  String?
  country   String?
  coordinates Json?

  // Capacity
  capacity Int?

  // Availability
  isActive        Boolean @default(true)
  operatingHours  Json? // { monday: { open: "09:00", close: "21:00" }, ... }

  // Amenities
  amenities String[]
  images    String[]

  // Contact
  contactName  String?
  contactPhone String?
  contactEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation      @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  bookings     FacilityBooking[]

  @@index([organisationId])
  @@index([type])
  @@index([isActive])
  @@map("facilities")
}

model FacilityBooking {
  id         String @id @default(cuid())
  facilityId String

  startTime DateTime
  endTime   DateTime

  purpose     String
  description String?
  bookedBy    String

  status BookingStatus @default(PENDING)

  // Recurring
  isRecurring     Boolean @default(false)
  recurrenceRule  String?
  parentBookingId String?

  // Cost
  cost     Float?
  currency String @default("GBP")
  paid     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@index([startTime, endTime])
  @@index([status])
  @@index([bookedBy])
  @@map("facility_bookings")
}

// ============================================================================
// üì¢ ANNOUNCEMENTS - NEW
// ============================================================================

model Announcement {
  id     String @id @default(cuid())
  clubId String

  title    String
  content  String  @db.Text
  excerpt  String?

  priority AnnouncementPriority @default(NORMAL)
  status   AnnouncementStatus   @default(DRAFT)

  // Scheduling
  publishAt DateTime?
  expiresAt DateTime?

  // Targeting
  targetRoles    ClubMemberRole[]
  targetTeamIds  String[]
  isPublic       Boolean @default(false)

  // Attachments
  attachments String[]
  imageUrl    String?

  // Engagement
  viewCount Int @default(0)

  // Author
  authorId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club   Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  author User @relation("announcementCreator", fields: [authorId], references: [id])

  @@index([clubId])
  @@index([status])
  @@index([publishAt])
  @@index([priority])
  @@map("announcements")
}

// ============================================================================
// üí∞ BILLING & SUBSCRIPTION MODELS
// ============================================================================

model Subscription {
  id             String  @id @default(cuid())
  userId         String?
  organisationId String?

  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  stripePriceId        String?

  status SubscriptionStatus @default(ACTIVE)
  tier   AccountTier        @default(FREE)

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  trialStart DateTime?
  trialEnd   DateTime?

  cancelledAt     DateTime?
  cancelledReason String?
  cancelAtPeriodEnd Boolean @default(false)

  // Usage based
  usageLimit   Int?
  usageCurrent Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation Organisation? @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organisationId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model Payment {
  id     String  @id @default(cuid())
  userId String?

  amount   Float
  currency String @default("GBP")

  status PaymentStatus @default(PENDING)
  type   PaymentType   @default(SUBSCRIPTION)

  stripePaymentIntentId String? @unique
  stripeChargeId        String?

  description String?
  metadata    Json?

  // Refund info
  refundedAmount Float?
  refundedAt     DateTime?
  refundReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("payments")
}

model Invoice {
  id     String @id @default(cuid())
  userId String

  invoiceNumber String @unique
  amount        Float
  tax           Float?
  total         Float
  currency      String @default("GBP")

  issuedAt DateTime
  dueAt    DateTime
  paidAt   DateTime?

  status String @default("ISSUED")

  // Line items
  lineItems Json?

  pdfUrl       String?
  stripeInvoiceId String?

  // Dunning
  remindersSent Int @default(0)
  lastReminder  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([dueAt])
  @@index([invoiceNumber])
  @@map("invoices")
}

// ============================================================================
// ü§ù SPONSORS - NEW
// ============================================================================

model Sponsor {
  id             String @id @default(cuid())
  organisationId String

  name        String
  logo        String?
  website     String?
  description String? @db.Text

  // Contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation  @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  clubSponsors ClubSponsor[]

  @@index([organisationId])
  @@index([isActive])
  @@map("sponsors")
}

model ClubSponsor {
  id        String @id @default(cuid())
  clubId    String
  sponsorId String

  // Deal details
  type         String // MAIN, KIT, SLEEVE, TRAINING, STADIUM
  value        Float?
  currency     String @default("GBP")
  startDate    DateTime
  endDate      DateTime?

  // Deliverables
  deliverables Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club    Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@unique([clubId, sponsorId, type])
  @@index([clubId])
  @@index([sponsorId])
  @@map("club_sponsors")
}

// ============================================================================
// üì± NOTIFICATIONS & MESSAGING
// ============================================================================

model Notification {
  id     String @id @default(cuid())
  userId String

  title   String
  message String @db.Text
  type    String

  read   Boolean   @default(false)
  readAt DateTime?

  link     String?
  metadata Json?

  // Delivery
  emailSent Boolean @default(false)
  pushSent  Boolean @default(false)

  // Scheduling
  scheduledFor DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Email preferences
  emailMatches    Boolean @default(true)
  emailTeam       Boolean @default(true)
  emailCoach      Boolean @default(true)
  emailTraining   Boolean @default(true)
  emailNews       Boolean @default(false)
  emailMarketing  Boolean @default(false)

  // Push preferences
  pushMatches     Boolean @default(true)
  pushTeam        Boolean @default(true)
  pushTraining    Boolean @default(true)
  pushChat        Boolean @default(true)

  // SMS preferences
  smsMatches      Boolean @default(false)
  smsUrgent       Boolean @default(false)

  // Quiet hours
  quietHoursStart String? // "22:00"
  quietHoursEnd   String? // "08:00"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

// ============================================================================
// üí¨ CHAT SYSTEM - NEW (FIXED)
// ============================================================================

model Chat {
  id String @id @default(cuid())

  type ChatType @default(DIRECT)
  name String?

  // For team/club chats
  teamId String?
  clubId String?

  // Settings
  isArchived Boolean @default(false)
  isMuted    Boolean @default(false)

  // Last activity
  lastMessageAt DateTime?
  lastMessagePreview String?

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator  User         @relation("chatCreator", fields: [createdBy], references: [id])
  members  ChatMember[]
  messages Message[]

  @@index([type])
  @@index([teamId])
  @@index([clubId])
  @@index([lastMessageAt])
  @@map("chats")
}

model Message {
  id       String @id @default(cuid())
  senderId String
  chatId   String

  content String @db.Text

  // Attachments
  attachments Json?

  // Status
  readBy    String[] @default([])
  editedAt  DateTime?

  // Reply to
  replyToId String?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([chatId])
  @@index([createdAt])
  @@map("messages")
}

model ChatMember {
  id     String @id @default(cuid())
  userId String
  chatId String

  role    String @default("MEMBER") // ADMIN, MEMBER
  joinedAt DateTime @default(now())
  leftAt   DateTime?

  // Notifications
  isMuted       Boolean @default(false)
  lastReadAt    DateTime?
  unreadCount   Int     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
  @@map("chat_members")
}

// ============================================================================
// üë• SOCIAL & GAMIFICATION
// ============================================================================

model Follow {
  id          String @id @default(cuid())
  followerId  String
  followingId String

  createdAt DateTime @default(now())

  follower  User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model UserBlock {
  id        String @id @default(cuid())
  blockerId String
  blockedId String

  reason String?

  createdAt DateTime @default(now())

  blocker User @relation("blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@map("user_blocks")
}

model SocialAction {
  id     String @id @default(cuid())
  userId String

  type         String // LIKE, SHARE, COMMENT, BOOKMARK
  resourceId   String
  resourceType String

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, resourceId, resourceType])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@map("social_actions")
}

model Achievement {
  id String @id @default(cuid())

  userId   String?
  playerId String?
  coachId  String?

  type        String
  title       String
  description String? @db.Text
  icon        String?

  // Progress
  progress Int @default(100) // Percentage
  tier     String? // BRONZE, SILVER, GOLD, PLATINUM

  unlockedAt DateTime @default(now())

  user   User?   @relation("achievementUser", fields: [userId], references: [id], onDelete: Cascade)
  player Player? @relation("achievementPlayer", fields: [playerId], references: [id], onDelete: Cascade)
  coach  Coach?  @relation("achievementCoach", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([playerId])
  @@index([coachId])
  @@index([type])
  @@map("achievements")
}

model Badge {
  id String @id @default(cuid())

  userId   String?
  playerId String?

  name        String
  description String?
  icon        String?
  category    String?

  // Rarity
  rarity String @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY

  awardedAt DateTime @default(now())

  user   User?   @relation("badgeUser", fields: [userId], references: [id], onDelete: Cascade)
  player Player? @relation("badgePlayer", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([playerId])
  @@index([category])
  @@map("badges")
}

// ============================================================================
// üìπ MEDIA ASSETS - NEW
// ============================================================================

model MediaAsset {
  id             String @id @default(cuid())
  organisationId String

  type     String // IMAGE, VIDEO, DOCUMENT
  filename String
  url      String
  mimeType String

  // Dimensions (for images/videos)
  width  Int?
  height Int?

  // Size
  sizeBytes Int

  // Video specific
  duration           Int? // seconds
  thumbnailUrl       String?
  processingStatus   TranscodingStatus?
  processingProvider VideoProcessingProvider?

  // Metadata
  alt         String?
  description String?
  tags        String[]

  // Usage tracking
  usageCount Int @default(0)

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@index([type])
  @@index([createdAt])
  @@map("media_assets")
}

// ============================================================================
// üîå API & INTEGRATIONS
// ============================================================================

model Webhook {
  id             String @id @default(cuid())
  organisationId String

  name   String?
  event  WebhookEvent
  url    String

  isActive Boolean @default(true)
  secret   String?

  // Headers
  headers Json?

  // Retry config
  maxRetries   Int @default(3)
  retryDelayMs Int @default(1000)

  failureCount  Int       @default(0)
  lastFailedAt  DateTime?
  lastSuccessAt DateTime?
  lastError     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organisation Organisation    @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organisationId])
  @@index([event])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id        String @id @default(cuid())
  webhookId String

  event    WebhookEvent
  payload  Json
  response Json?

  statusCode   Int?
  success      Boolean
  errorMessage String?
  durationMs   Int?

  attemptNumber Int @default(1)

  createdAt DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([success])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model ApiUsageMetrics {
  id             String @id @default(cuid())
  organisationId String

  date DateTime @db.Date

  callsCount          Int    @default(0)
  averageResponseTime Float?
  errorCount          Int    @default(0)
  bandwidthBytes      BigInt @default(0)

  // Breakdown by endpoint
  endpointBreakdown Json?

  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, date])
  @@index([organisationId])
  @@index([date])
  @@map("api_usage_metrics")
}

model QuotaUsage {
  id             String @id @default(cuid())
  organisationId String

  usersUsed             Int @default(0)
  teamsUsed             Int @default(0)
  storageUsedMb         Int @default(0)
  apiCallsUsedThisMonth Int @default(0)
  matchesThisMonth      Int @default(0)

  // Reset tracking
  monthlyResetDate DateTime?

  updatedAt DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@map("quota_usage")
}

// ============================================================================
// üîÑ BACKUP & MAINTENANCE
// ============================================================================

model DatabaseBackup {
  id             String @id @default(cuid())
  organisationId String

  type   String @default("FULL") // FULL, INCREMENTAL
  size   Int
  status String @default("COMPLETED")

  backupUrl String?
  checksum  String?
  expiresAt DateTime

  // Metadata
  tablesIncluded String[]
  rowsCaptured   Int?

  createdAt DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@index([expiresAt])
  @@index([status])
  @@map("database_backups")
}

// ============================================================================
// üìä VIEWS (Read-only computed data)
// ============================================================================

// These can be created as database views for performance
// view PlayerLeaderboard {
//   playerId String @unique
//   goals Int
//   assists Int
//   appearances Int
//   rating Float
//   rank Int
// }
