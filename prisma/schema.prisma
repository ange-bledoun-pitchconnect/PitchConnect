// ============================================================================
// PITCHCONNECT DATABASE SCHEMA (Prisma ORM) - ENHANCED PRODUCTION VERSION
// PostgreSQL via Supabase
// Production-ready with TypeScript strict mode support
// INCLUDES: Complete League Admin System + SuperAdmin Audit & Security
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS - CORE SYSTEM
// ============================================================================

enum UserRole {
  SUPERADMIN
  PLAYER
  PLAYER_PRO
  COACH
  CLUB_MANAGER
  LEAGUE_ADMIN
  PARENT
  TREASURER
  REFEREE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

enum TeamType {
  PROFESSIONAL
  SEMI_PROFESSIONAL
  AMATEUR
  YOUTH
  POWERLEAGUE
}

enum Position {
  GOALKEEPER
  DEFENDER
  MIDFIELDER
  FORWARD
}

enum PreferredFoot {
  LEFT
  RIGHT
  BOTH
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FINISHED
  CANCELLED
  POSTPONED
}

enum MatchAttendanceStatus {
  AVAILABLE
  UNAVAILABLE
  CONFIRMED
  MAYBE
  LATE
  NO_SHOW
  EXCUSED_ABSENCE
  INJURED
  ILL
  SUSPENDED
  NOT_SELECTED
  SUBSTITUTE
  STARTING_LINEUP
  ATTENDED
}

enum MatchEventType {
  GOAL
  ASSIST
  YELLOW_CARD
  RED_CARD
  SUBSTITUTION
  INJURY_TIME
  FULLTIME
  HALFTIME
  KICKOFF
}

enum Formation {
  FOUR_FOUR_TWO
  FOUR_THREE_THREE
  THREE_FIVE_TWO
  FIVE_THREE_TWO
  FIVE_FOUR_ONE
  THREE_FOUR_THREE
  FOUR_TWO_THREE_ONE
  FOUR_ONE_FOUR_ONE
}

enum SubscriptionTier {
  FREE
  PLAYER_PRO
  COACH
  MANAGER
  LEAGUE_ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
  PAST_DUE
  TRIAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  MATCH_SCHEDULED
  MATCH_REMINDER
  TRAINING_SESSION
  TEAM_MESSAGE
  ACHIEVEMENT_UNLOCKED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PLAYER_STATS_UPDATE
  SYSTEM_ALERT
  UPGRADE_REQUEST_APPROVED
  UPGRADE_REQUEST_REJECTED
  ROLE_CHANGED
  ACCOUNT_SUSPENDED
  MATCH_ATTENDANCE_REQUEST
  TIMESHEET_APPROVED
  TIMESHEET_REJECTED
  PAYMENT_PROCESSED
  JOIN_REQUEST
}

enum TrainingIntensity {
  LOW
  MEDIUM
  HIGH
}

enum TrainingCategory {
  PASSING
  SHOOTING
  DEFENDING
  POSSESSION
  SET_PIECES
  CONDITIONING
  TACTICAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum UpgradeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum AuditActionType {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  USER_BANNED
  USER_UNBANNED
  ROLE_UPGRADED
  ROLE_DOWNGRADED
  SUBSCRIPTION_GRANTED
  SUBSCRIPTION_CANCELLED
  PAYMENT_REFUNDED
  DATA_EXPORTED
  USER_IMPERSONATED
  IMPERSONATION_ENDED
  SECURITY_SETTINGS_UPDATED
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  LOGIN_ATTEMPT
  FAILED_LOGIN
  API_KEY_GENERATED
  API_KEY_REVOKED
  BULK_USER_ACTION
  SYSTEM_MAINTENANCE
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PAID
}

enum PaymentType {
  SUBSCRIPTION
  COACHING_FEE
  MATCH_FEE
  TOURNAMENT_FEE
  REFUND
  OTHER
}

enum LeagueFormat {
  ROUND_ROBIN
  DOUBLE_ROUND_ROBIN
  KNOCKOUT
  GROUP_KNOCKOUT
  CUSTOM
}

enum LeagueVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ResultApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
}

// ============================================================================
// USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  firstName     String
  lastName      String
  phoneNumber   String?
  avatar        String?
  dateOfBirth   DateTime?
  nationality   String?

  roles  UserRole[]
  status UserStatus @default(PENDING_VERIFICATION)

  isSuperAdmin  Boolean   @default(false)
  lastLoginIp   String?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // Security & 2FA
  twoFactorSecret       String?
  twoFactorEnabled      Boolean                 @default(false)
  twoFactorBackupCodes  String? // JSON array
  twoFactorVerifiedAt   DateTime?
  
  // Login Security
  lastFailedLoginAt     DateTime?
  failedLoginCount      Int                     @default(0)
  lockedUntilAt         DateTime?
  passwordChangedAt     DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  // Relations
  accounts              Account[]
  sessions              Session[]
  preferences           UserPreferences?
  playerProfile         Player?
  coachProfile          Coach?
  clubManager           ClubManager?
  leagueAdmin           LeagueAdmin?
  parentProfile         Parent?
  treasurerProfile      Treasurer?
  refereeProfile        Referee?
  subscription          Subscription?
  payments              Payment[]
  notifications         Notification[]
  scoutingReports       ScoutingProfile[]
  sentMessages          Message[]         @relation("MessageSender")
  upgradeRequests       UpgradeRequest[]
  
  // Audit & Security
  auditLogsPerformed    AuditLog[]              @relation("AuditLogPerformedBy")
  auditLogsTarget       AuditLog[]              @relation("AuditLogTargetUser")
  impersonationSessions ImpersonationSession[]  @relation("ImpersonationAdmin")
  impersonationTargets  ImpersonationSession[]  @relation("ImpersonationTarget")
  
  // API Keys & Admin
  apiKeys               ApiKey[]
  approvedTimesheets    CoachTimesheet[]        @relation("TimesheetApprover")
  processedPayments     CoachPayment[]          @relation("PaymentProcessor")
  announcementsCreated  Announcement[]
  videosUploaded        Video[]    @relation("videosUploaded")

  // Club & Team Relations
  ownedClubs            Club[]          @relation("ClubOwner")
  clubMemberships       ClubMember[]    @relation("ClubMemberships")
  teamMemberships       TeamMember[]    @relation("TeamMemberships")
  userRoles             UserRole_User[] @relation("UserRoles")
  joinRequests          JoinRequest[]   @relation("UserJoinRequests")

  @@index([email])
  @@index([status])
  @@index([isSuperAdmin])
  @@map("users")
}

model UserRole_User {
  id       String   @id @default(cuid())
  userId   String
  roleName UserRole

  user User @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleName])
  @@index([userId])
  @@index([roleName])
  @@map("user_roles")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  theme    String @default("auto")
  language String @default("en-GB")
  timezone String @default("Europe/London")
  currency String @default("GBP")

  notificationsEmail Boolean @default(true)
  notificationsSMS   Boolean @default(false)
  notificationsPush  Boolean @default(true)

  privateProfile Boolean @default(false)
  analyticsLevel String  @default("BASIC")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================================================
// AUDIT & SECURITY MODELS (ENHANCED)
// ============================================================================

model AuditLog {
  id            String          @id @default(cuid())
  performedById String
  performedBy   User            @relation("AuditLogPerformedBy", fields: [performedById], references: [id], onDelete: Cascade)
  
  targetUserId  String?
  targetUser    User?           @relation("AuditLogTargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)
  
  action        AuditActionType
  entityType    String? // USER, PAYMENT, SUBSCRIPTION, etc.
  entityId      String?
  changes       Json? // Track what changed: {old: {}, new: {}}
  details       String?         @db.Text // Additional context as JSON
  
  ipAddress     String?
  userAgent     String?
  severity      String          @default("INFO") // INFO, WARNING, CRITICAL

  createdAt DateTime @default(now())

  @@index([performedById])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([performedById, createdAt])
  @@index([severity, createdAt])
  @@map("audit_logs")
}

model ImpersonationSession {
  id           String    @id @default(cuid())
  adminId      String
  admin        User      @relation("ImpersonationAdmin", fields: [adminId], references: [id], onDelete: Cascade)
  
  targetUserId String
  targetUser   User      @relation("ImpersonationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  
  ipAddress    String?
  userAgent    String?
  reason       String?
  
  activities   Json? // Track admin actions during impersonation
  
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

model SecuritySetting {
  id String @id @default(cuid())

  // Session Security
  sessionTimeoutMinutes    Int     @default(30)
  maxLoginAttemptsAllowed  Int     @default(5)
  lockoutDurationMinutes   Int     @default(15)
  passwordExpirationDays   Int?    @default(90)
  
  // IP & Access Control
  ipWhitelist              String[] // JSON array of IPs
  ipBlacklist              String[]
  restrictAccessByIP       Boolean @default(false)
  
  // 2FA & Authentication
  twoFactorRequired        Boolean @default(false)
  allowApiKeys             Boolean @default(true)
  apiKeyRotationDays       Int     @default(90)
  
  // Audit & Monitoring
  auditLoggingEnabled      Boolean @default(true)
  alertOnSuspiciousActivity Boolean @default(true)
  
  // Data Protection
  encryptSensitiveData     Boolean @default(true)
  gdprDeletionRetentionDays Int   @default(30)
  
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@map("security_settings")
}

model LoginAttempt {
  id       String   @id @default(cuid())
  email    String
  success  Boolean
  ipAddress String?
  userAgent String?
  reason   String? // Why it failed (invalid password, account locked, etc.)
  
  attemptedAt DateTime @default(now())

  @@index([email])
  @@index([attemptedAt])
  @@index([success])
  @@index([email, attemptedAt])
  @@map("login_attempts")
}

model ApiKey {
  id       String   @id @default(cuid())
  userId   String
  name     String
  key      String   @unique // Hash this in production
  prefix   String   // First 8 chars for display
  
  lastUsedAt DateTime?
  expiresAt DateTime?
  revokedAt DateTime?
  
  scopes   String[] // Permissions: ["users:read", "payments:write", etc.]
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([key])
  @@index([expiresAt])
  @@map("api_keys")
}

// ============================================================================
// CLUB & TEAM MODELS
// ============================================================================

model Club {
  id             String  @id @default(cuid())
  name           String
  city           String
  country        String  @default("United Kingdom")
  foundedYear    Int?
  description    String? @db.Text
  stadiumName    String?
  logoUrl        String?
  primaryColor   String  @default("#FFD700")
  secondaryColor String  @default("#FF6B35")
  status         String  @default("ACTIVE")
  ownerId        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User         @relation("ClubOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  teams   Team[]
  members ClubMember[]

  @@index([ownerId])
  @@index([status])
  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(cuid())
  clubId   String
  userId   String
  role     String // OWNER, MANAGER, COACH, STAFF
  status   String   @default("ACTIVE")
  joinedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation("ClubMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_members")
}

model Team {
  id       String @id @default(cuid())
  name     String
  clubId   String
  ageGroup String @default("SENIOR")
  category String @default("FIRST_TEAM")
  status   String @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club          Club               @relation(fields: [clubId], references: [id], onDelete: Cascade)
  members       TeamMember[]
  joinRequests  JoinRequest[]
  invitations   LeagueInvitation[]
  announcements Announcement[]
  videos        Video[]

  @@index([clubId])
  @@index([status])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String // MANAGER, COACH, PLAYER, STAFF
  status   String   @default("ACTIVE")
  joinedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("TeamMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model JoinRequest {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("UserJoinRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
  @@index([status])
  @@map("join_requests")
}

// ============================================================================
// UPGRADE REQUEST SYSTEM
// ============================================================================

model UpgradeRequest {
  id            String               @id @default(cuid())
  userId        String
  currentRole   UserRole
  requestedRole UserRole
  reason        String               @db.Text
  status        UpgradeRequestStatus @default(PENDING)

  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("upgrade_requests")
}

// ============================================================================
// PLAYER MODELS
// ============================================================================

model Player {
  id            String @id @default(cuid())
  userId        String @unique
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  nationality   String
  height        Float?
  weight        Float?
  position      Position
  preferredFoot PreferredFoot
  shirtNumber   Int?
  photo         String?

  status           String  @default("ACTIVE")
  developmentNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  stats              PlayerStats[]
  teams              TeamPlayer[]
  achievements       PlayerAchievement[]
  scoutingProfiles   ScoutingProfile[]
  matchEvents        MatchEvent[]
  trainingAttendance TrainingAttendance[]
  tacticPositions    TacticPlayer[]
  matchAttendance    MatchAttendance[]
  injuries           Injury[]
  contracts          Contract[]

  @@index([userId])
  @@index([position])
  @@map("players")
}

model PlayerStats {
  id       String @id @default(cuid())
  playerId String
  season   Int

  appearances   Int @default(0)
  goals         Int @default(0)
  assists       Int @default(0)
  minutesPlayed Int @default(0)

  passingAccuracy Float?
  tackles         Int?
  interceptions   Int?
  shotsOnTarget   Int?

  sprintDistance Float?
  topSpeed       Float?
  acceleration   Float?

  expectedGoals   Float?
  expectedAssists Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season])
  @@index([playerId])
  @@index([season])
  @@map("player_stats")
}

model Injury {
  id          String    @id @default(cuid())
  playerId    String
  type        String    // MUSCLE_STRAIN, FRACTURE, etc.
  severity    String    @default("MINOR")
  dateFrom    DateTime
  dateTo      DateTime?
  description String?   @db.Text
  treatment   String?
  status      String    @default("ACTIVE") // ACTIVE, RECOVERED, CHRONIC
  
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([playerId])
  @@index([dateFrom])
  @@map("injuries")
}

model Contract {
  id          String   @id @default(cuid())
  playerId    String
  clubId      String?
  position    Position
  salary      Float?
  startDate   DateTime
  endDate     DateTime?
  type        String   // PROFESSIONAL, SEMI_PRO, AMATEUR
  status      String   @default("ACTIVE")
  documentUrl String?
  
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([playerId])
  @@index([status])
  @@map("contracts")
}

// ============================================================================
// COACH & CLUB MANAGER MODELS
// ============================================================================

model Coach {
  id     String @id @default(cuid())
  userId String @unique

  bio             String?  @db.Text
  yearsExperience Int?
  qualifications  String[]
  specializations String[]

  hourlyRate   Float?
  bankDetails  Json?
  taxId        String?
  contractType String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  oldTeams         OldTeam[]
  trainingSessions TrainingSession[]
  tactics          Tactic[]
  timesheets       CoachTimesheet[]
  payments         CoachPayment[]

  @@index([userId])
  @@map("coaches")
}

model ClubManager {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  oldClubs OldClub[]

  @@index([userId])
  @@map("club_managers")
}

model Treasurer {
  id          String  @id @default(cuid())
  userId      String  @unique
  clubId      String?
  permissions Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([clubId])
  @@map("treasurers")
}

model Referee {
  id                String  @id @default(cuid())
  userId            String  @unique
  licenseNumber     String? @unique
  licenseLevel      String? // FIFA, UEFA, National, Regional
  yearsOfExperience Int?
  specialization    String? // Sport specialization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchAssignments Match[]
  resultApprovals  MatchResultApproval[]

  @@index([userId])
  @@map("referees")
}

model Parent {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("parents")
}

// ============================================================================
// OLD CLUB & TEAM MODELS (Legacy - For backward compatibility)
// ============================================================================

model OldClub {
  id       String    @id @default(cuid())
  name     String
  code     String    @unique
  logo     String?
  founded  DateTime?
  city     String
  country  String
  teamType TeamType
  status   String    @default("ACTIVE")

  email     String?
  phone     String?
  website   String?
  managerId String
  manager   ClubManager @relation(fields: [managerId], references: [id])
  teams     OldTeam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([managerId])
  @@map("old_clubs")
}

model OldTeam {
  id       String @id @default(cuid())
  clubId   String
  name     String
  category String
  season   Int
  status   String @default("ACTIVE")

  club              OldClub           @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coachId           String
  coach             Coach             @relation(fields: [coachId], references: [id])
  players           TeamPlayer[]
  homeMatches       Match[]           @relation("HomeTeam")
  awayMatches       Match[]           @relation("AwayTeam")
  trainingSessions  TrainingSession[]
  tactics           Tactic[]
  leagueMemberships LeagueTeam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clubId])
  @@index([coachId])
  @@index([season])
  @@map("old_teams")
}

model TeamPlayer {
  id        String    @id @default(cuid())
  teamId    String
  playerId  String
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isCaptain Boolean   @default(false)

  team   OldTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Player  @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@index([playerId])
  @@map("team_players")
}

// ============================================================================
// LEAGUE & FIXTURES MODELS (ENHANCED)
// ============================================================================

model League {
  id      String  @id @default(cuid())
  name    String
  code    String  @unique
  sport   String  @default("Football")
  logo    String?
  country String
  season  Int
  status  String  @default("ACTIVE")

  pointsWin  Int @default(3)
  pointsDraw Int @default(1)
  pointsLoss Int @default(0)

  format     LeagueFormat     @default(ROUND_ROBIN)
  visibility LeagueVisibility @default(PUBLIC)

  adminId   String
  admin     LeagueAdmin  @relation(fields: [adminId], references: [id])
  teams     LeagueTeam[]
  fixtures  Fixture[]
  standings Standings[]

  seasons       LeagueSeason[]
  configuration LeagueConfiguration?
  invitations   LeagueInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([adminId])
  @@index([season])
  @@map("leagues")
}

model LeagueSeason {
  id        String    @id @default(cuid())
  leagueId  String
  name      String
  startDate DateTime
  endDate   DateTime?
  isActive  Boolean   @default(true)
  isCurrent Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId])
  @@map("league_seasons")
}

model LeagueConfiguration {
  id       String @id @default(cuid())
  leagueId String @unique

  pointsForWin  Int @default(3)
  pointsForDraw Int @default(1)
  pointsForLoss Int @default(0)

  bonusPointsEnabled  Boolean @default(false)
  bonusPointsForGoals Int?

  minTeams Int  @default(2)
  maxTeams Int?

  registrationOpen     Boolean   @default(true)
  registrationDeadline DateTime?
  entryFee             Float?

  minPlayerAge      Int?
  maxPlayerAge      Int?
  maxPlayersPerTeam Int?

  tiebreaker1 String @default("GOAL_DIFFERENCE")
  tiebreaker2 String @default("GOALS_SCORED")
  tiebreaker3 String @default("HEAD_TO_HEAD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@map("league_configurations")
}

model LeagueInvitation {
  id          String           @id @default(cuid())
  leagueId    String
  teamId      String
  invitedBy   String
  message     String?
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime?
  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team   Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  admin  LeagueAdmin @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([teamId])
  @@index([invitedBy])
  @@map("league_invitations")
}

model LeagueAdmin {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  leagues         League[]
  invitationsSent LeagueInvitation[]

  @@index([userId])
  @@map("league_admins")
}

model LeagueTeam {
  id       String    @id @default(cuid())
  leagueId String
  teamId   String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  league League  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team   OldTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([teamId])
  @@map("league_teams")
}

model Fixture {
  id        String @id @default(cuid())
  leagueId  String
  matchweek Int
  season    Int
  status    String @default("UPCOMING")

  league  League  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  matches Match[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leagueId])
  @@index([matchweek])
  @@index([season])
  @@map("fixtures")
}

model Standings {
  id       String @id @default(cuid())
  leagueId String
  teamId   String
  position Int

  played Int @default(0)
  won    Int @default(0)
  drawn  Int @default(0)
  lost   Int @default(0)

  goalsFor       Int @default(0)
  goalsAgainst   Int @default(0)
  goalDifference Int @default(0)

  points Int @default(0)

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@index([position])
  @@map("standings")
}

// ============================================================================
// MATCH & EVENT MODELS (ENHANCED)
// ============================================================================

model Match {
  id         String      @id @default(cuid())
  fixtureId  String?
  homeTeamId String
  awayTeamId String
  refereeId  String?
  date       DateTime
  venue      String?
  status     MatchStatus @default(SCHEDULED)

  homeGoals  Int?
  awayGoals  Int?
  attendance Int?

  attendanceDeadline DateTime?

  fixture           Fixture?              @relation(fields: [fixtureId], references: [id], onDelete: SetNull)
  homeTeam          OldTeam               @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam          OldTeam               @relation("AwayTeam", fields: [awayTeamId], references: [id])
  referee           Referee?              @relation(fields: [refereeId], references: [id], onDelete: SetNull)
  events            MatchEvent[]
  stats             MatchStats?
  playerAttendances MatchAttendance[]
  resultApprovals   MatchResultApproval[]
  videos            Video[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fixtureId])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([refereeId])
  @@index([date])
  @@index([status])
  @@map("matches")
}

model MatchResultApproval {
  id          String               @id @default(cuid())
  matchId     String
  submittedBy String
  approvedBy  String?
  status      ResultApprovalStatus @default(PENDING)

  homeScore Int
  awayScore Int
  notes     String?

  submittedAt DateTime  @default(now())
  reviewedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match   Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  referee Referee? @relation(fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([matchId])
  @@index([submittedBy])
  @@index([approvedBy])
  @@index([status])
  @@map("match_result_approvals")
}

model MatchAttendance {
  id       String                @id @default(cuid())
  matchId  String
  playerId String
  status   MatchAttendanceStatus @default(AVAILABLE)

  respondedAt       DateTime?
  confirmedBy       String?
  notes             String?   @db.Text
  minutesPlayed     Int?
  performanceRating Float?

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@index([status])
  @@map("match_attendance")
}

model MatchEvent {
  id             String         @id @default(cuid())
  matchId        String
  playerId       String?
  type           MatchEventType
  minute         Int
  additionalInfo String?

  match  Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([matchId])
  @@index([playerId])
  @@index([minute])
  @@map("match_events")
}

model MatchStats {
  id      String @id @default(cuid())
  matchId String @unique

  homeTeamId        String
  homePossession    Int?
  homeShots         Int?
  homeShotsOnTarget Int?
  homePasses        Int?
  homePassAccuracy  Float?
  homeTackles       Int?
  homeFouls         Int?
  homeCorners       Int?

  awayTeamId        String
  awayPossession    Int?
  awayShots         Int?
  awayShotsOnTarget Int?
  awayPasses        Int?
  awayPassAccuracy  Float?
  awayTackles       Int?
  awayFouls         Int?
  awayCorners       Int?

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@map("match_stats")
}

// ============================================================================
// TRAINING MODELS
// ============================================================================

model TrainingSession {
  id       String   @id @default(cuid())
  teamId   String
  coachId  String
  date     DateTime
  duration Int
  location String?
  focus    String
  notes    String?  @db.Text

  team       OldTeam              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  coach      Coach                @relation(fields: [coachId], references: [id])
  drills     SessionDrill[]
  attendance TrainingAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([coachId])
  @@index([date])
  @@map("training_sessions")
}

model Drill {
  id          String            @id @default(cuid())
  name        String
  description String            @db.Text
  duration    Int
  intensity   TrainingIntensity
  playerCount Int
  difficulty  String
  category    TrainingCategory

  sessions SessionDrill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("drills")
}

model SessionDrill {
  id                String @id @default(cuid())
  trainingSessionId String
  drillId           String
  order             Int

  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  drill           Drill           @relation(fields: [drillId], references: [id])

  @@unique([trainingSessionId, drillId])
  @@index([trainingSessionId])
  @@index([drillId])
  @@map("session_drills")
}

model TrainingAttendance {
  id                String           @id @default(cuid())
  trainingSessionId String
  playerId          String
  status            AttendanceStatus
  performanceRating Int?
  notes             String?

  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  player          Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([trainingSessionId, playerId])
  @@index([trainingSessionId])
  @@index([playerId])
  @@map("training_attendance")
}

// ============================================================================
// COACH TIMESHEET & PAYMENT MODELS
// ============================================================================

model CoachTimesheet {
  id      String @id @default(cuid())
  coachId String
  period  String

  startDate DateTime
  endDate   DateTime

  trainingHours Float @default(0)
  matchHours    Float @default(0)
  adminHours    Float @default(0)
  otherHours    Float @default(0)
  totalHours    Float @default(0)

  hourlyRate  Float
  totalAmount Float

  status      TimesheetStatus @default(DRAFT)
  submittedAt DateTime?
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?         @db.Text
  approvedBy  String?
  approvedAt  DateTime?

  attachments String[]

  coach    Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  approver User? @relation("TimesheetApprover", fields: [approvedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("coach_timesheets")
}

model CoachPayment {
  id          String        @id @default(cuid())
  coachId     String
  timesheetId String?
  amount      Float
  currency    String        @default("GBP")
  paymentType PaymentType   @default(COACHING_FEE)
  status      PaymentStatus @default(PENDING)

  paymentMethod String?
  transactionId String?
  invoiceNumber String?
  invoiceUrl    String?

  processedBy String?
  processedAt DateTime?
  paidAt      DateTime?
  notes       String?   @db.Text

  coach     Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  processor User? @relation("PaymentProcessor", fields: [processedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([status])
  @@index([paymentType])
  @@map("coach_payments")
}

// ============================================================================
// TACTICAL MODELS
// ============================================================================

model Tactic {
  id             String    @id @default(cuid())
  coachId        String
  teamId         String
  name           String
  formation      Formation
  description    String?   @db.Text
  playStyle      String    @default("BALANCED")
  defensiveShape String    @default("COMPACT")
  pressType      String    @default("MID_BLOCK")

  coach           Coach          @relation(fields: [coachId], references: [id])
  team            OldTeam        @relation(fields: [teamId], references: [id])
  playerPositions TacticPlayer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([teamId])
  @@map("tactics")
}

model TacticPlayer {
  id       String   @id @default(cuid())
  tacticId String
  playerId String
  position Position
  role     String?

  tactic Tactic @relation(fields: [tacticId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([tacticId, playerId])
  @@index([tacticId])
  @@index([playerId])
  @@map("tactic_players")
}

// ============================================================================
// PAYMENT & SUBSCRIPTION MODELS
// ============================================================================

model Subscription {
  id     String             @id @default(cuid())
  userId String             @unique
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  monthlyPrice   Float?
  annualDiscount Boolean @default(false)
  customPrice    Float?
  grantedByAdmin Boolean @default(false)
  grantedBy      String?
  grantReason    String?

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?
  trialEndsAt        DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(cuid())
  subscriptionId String?
  userId         String
  amount         Float
  currency       String        @default("GBP")
  status         PaymentStatus @default(PENDING)
  paymentType    PaymentType   @default(SUBSCRIPTION)

  stripePaymentIntentId String? @unique
  stripeInvoiceId       String?
  invoiceUrl            String?

  refundedBy   String?
  refundReason String?

  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([paymentType])
  @@map("payments")
}

// ============================================================================
// GAMIFICATION MODELS
// ============================================================================

model Achievement {
  id          String  @id @default(cuid())
  name        String  @unique
  description String  @db.Text
  icon        String?
  criterion   String
  threshold   Int
  points      Int     @default(10)

  playerAchievements PlayerAchievement[]

  @@index([criterion])
  @@map("achievements")
}

model PlayerAchievement {
  id            String   @id @default(cuid())
  playerId      String
  achievementId String
  unlockedAt    DateTime @default(now())

  player      Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([playerId, achievementId])
  @@index([playerId])
  @@index([achievementId])
  @@map("player_achievements")
}

model Leaderboard {
  id       String  @id @default(cuid())
  leagueId String?
  teamId   String?
  type     String
  season   Int

  @@index([leagueId])
  @@index([teamId])
  @@index([type])
  @@index([season])
  @@map("leaderboards")
}

// ============================================================================
// SCOUTING MODELS
// ============================================================================

model ScoutingProfile {
  id               String   @id @default(cuid())
  playerId         String
  createdBy        String
  rating           Int
  strengths        String[]
  weaknesses       String[]
  potential        Int
  notes            String?  @db.Text
  videoLinks       String[]
  comparablePlayer String?

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  scout  User   @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([playerId])
  @@index([createdBy])
  @@index([rating])
  @@map("scouting_profiles")
}

// ============================================================================
// COMMUNICATION MODELS
// ============================================================================

model Message {
  id            String  @id @default(cuid())
  teamId        String?
  senderId      String
  content       String  @db.Text
  attachmentUrl String?

  sender     User               @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipients MessageRecipient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model MessageRecipient {
  id          String    @id @default(cuid())
  messageId   String
  recipientId String
  readAt      DateTime?

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, recipientId])
  @@index([messageId])
  @@index([recipientId])
  @@map("message_recipients")
}

// ============================================================================
// NOTIFICATION MODELS
// ============================================================================

model Notification {
  id       String           @id @default(cuid())
  userId   String
  type     NotificationType
  title    String
  message  String
  link     String?
  read     Boolean          @default(false)
  metadata Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// COMMUNICATION: ANNOUNCEMENTS & VIDEOS
// ============================================================================

model Announcement {
  id        String   @id @default(cuid())
  teamId    String
  createdBy String
  title     String
  content   String   @db.Text
  priority  String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  pinned    Boolean  @default(false)
  
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [createdBy], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([teamId])
  @@index([createdBy])
  @@map("announcements")
}

model Video {
  id        String  @id @default(cuid())
  teamId    String?
  matchId   String?
  createdBy String  
  title     String
  url       String
  duration  Int?
  type      String  @default("TRAINING")
  
  team    Team?   @relation(fields: [teamId], references: [id], onDelete: SetNull)
  match   Match?  @relation(fields: [matchId], references: [id], onDelete: SetNull)
  creator User    @relation("videosUploaded", fields: [createdBy], references: [id], onDelete: Cascade) // âœ… ADD THIS
  
  createdAt DateTime @default(now())
  
  @@index([teamId])
  @@index([matchId])
  @@index([createdBy]) 
  @@map("videos")
}

