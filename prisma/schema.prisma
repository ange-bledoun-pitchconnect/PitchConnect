// ============================================================================
// üåü PITCHCONNECT DATABASE SCHEMA v6.0.0 - ENTERPRISE GRADE
// ============================================================================
// Production-Ready | Multi-Tenant | GDPR-Compliant | Audit-Ready
// Technology: Next.js 15 | NextAuth v5 | Prisma 5.22.0+ | PostgreSQL 14+
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "driverAdapters", "views"]
  binaryTargets   = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// üìã ENUMS - COMPLETE SYSTEM
// ============================================================================

enum UserRole {
  SUPERADMIN
  ADMIN
  PLAYER
  PLAYER_PRO
  COACH
  COACH_PRO
  MANAGER
  CLUB_MANAGER
  CLUB_OWNER
  TREASURER
  REFEREE
  SCOUT
  ANALYST
  PARENT
  LEAGUE_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
  PENDING_EMAIL_VERIFICATION
  PENDING_PHONE_VERIFICATION
  ARCHIVED
  DELETED
}

enum UserType {
  INDIVIDUAL
  ORGANIZATION
  FAMILY
}

enum AccountTier {
  FREE
  PRO
  PREMIUM
  ENTERPRISE
}

enum OrganisationRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum OrganisationTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

enum PermissionType {
  // User management
  USER_CREATE
  USER_READ
  USER_UPDATE
  USER_DELETE
  USER_SUSPEND
  USER_BAN
  
  // Team management
  TEAM_CREATE
  TEAM_READ
  TEAM_UPDATE
  TEAM_DELETE
  TEAM_INVITE
  TEAM_REMOVE_MEMBER
  
  // Match management
  MATCH_CREATE
  MATCH_READ
  MATCH_UPDATE
  MATCH_DELETE
  MATCH_PUBLISH
  MATCH_APPROVE_RESULT
  MATCH_RECORD_STATS
  
  // Player management
  PLAYER_CREATE
  PLAYER_READ
  PLAYER_UPDATE
  PLAYER_DELETE
  PLAYER_VERIFY
  
  // Billing
  BILLING_READ
  BILLING_UPDATE
  BILLING_MANAGE_SUBSCRIPTIONS
  
  // Analytics
  ANALYTICS_VIEW
  ANALYTICS_EXPORT
  
  // API access
  API_ACCESS
  API_KEY_CREATE
  API_KEY_REVOKE
  
  // System
  SYSTEM_ADMIN
  AUDIT_LOG_VIEW
}

enum DataRetentionPolicy {
  EPHEMERAL     // 7 days
  TEMPORARY     // 30 days
  STANDARD      // 7 years (default)
  PERMANENT     // Forever
  DELETED       // Marked for deletion
}

enum Sport {
  FOOTBALL
  NETBALL
  RUGBY
  CRICKET
  AMERICAN_FOOTBALL
  BASKETBALL
  HOCKEY
  LACROSSE
  AUSTRALIAN_RULES
  GAELIC_FOOTBALL
}

enum Position {
  // Football/Soccer (16 positions)
  GOALKEEPER
  LEFT_BACK
  CENTER_BACK
  RIGHT_BACK
  LEFT_WING_BACK
  RIGHT_WING_BACK
  DEFENSIVE_MIDFIELDER
  CENTRAL_MIDFIELDER
  LEFT_MIDFIELDER
  RIGHT_MIDFIELDER
  ATTACKING_MIDFIELDER
  LEFT_WINGER
  RIGHT_WINGER
  STRIKER
  CENTER_FORWARD
  SECOND_STRIKER
  
  // Netball (7 positions)
  GOALKEEPER_NETBALL
  GOAL_ATTACK
  WING_ATTACK
  CENTER
  WING_DEFENSE
  GOAL_DEFENSE
  GOAL_SHOOTER
  
  // Rugby Union (15 positions)
  PROP
  HOOKER
  LOCK
  FLANKER
  NUMBER_8
  SCRUM_HALF
  FLY_HALF
  INSIDE_CENTER
  OUTSIDE_CENTER
  FULLBACK
  
  // Rugby League
  HOOKER_LEAGUE
  PROP_LEAGUE
  SECOND_ROW
  LOOSE_FORWARD
  
  // American Football
  QUARTERBACK
  RUNNING_BACK
  WIDE_RECEIVER
  TIGHT_END
  LEFT_TACKLE
  LEFT_GUARD
  CENTER_POSITION
  RIGHT_GUARD
  RIGHT_TACKLE
  LINEBACKER
  DEFENSIVE_END
  DEFENSIVE_TACKLE
  SAFETY
  CORNERBACK
  PUNTER
  KICKER
  
  // Basketball
  POINT_GUARD
  SHOOTING_GUARD
  SMALL_FORWARD
  POWER_FORWARD
  CENTER_BASKETBALL
  
  // Cricket
  BATSMAN
  BOWLER
  ALL_ROUNDER
  FIELDER
  WICKET_KEEPER
  
  // Hockey
  GOALTENDER
  DEFENSEMAN
  WINGER
  CENTER_HOCKEY
  
  // Other
  UTILITY
  SUBSTITUTE
}

enum PreferredFoot {
  LEFT
  RIGHT
  BOTH
}

enum MatchStatus {
  SCHEDULED
  LIVE
  HALFTIME
  SECOND_HALF
  FINISHED
  CANCELLED
  POSTPONED
  ABANDONED
  REPLAY_SCHEDULED
  VOIDED
}

enum MatchAttendanceStatus {
  AVAILABLE
  UNAVAILABLE
  CONFIRMED
  MAYBE
  LATE
  NO_SHOW
  EXCUSED_ABSENCE
  INJURED
  ILL
  SUSPENDED
  NOT_SELECTED
  SUBSTITUTE
  STARTING_LINEUP
  ATTENDED
  UNUSED_SUB
  UNUSED_SQUAD
}

enum MatchEventType {
  GOAL
  ASSIST
  YELLOW_CARD
  RED_CARD
  SUBSTITUTION_ON
  SUBSTITUTION_OFF
  INJURY
  INJURY_TIME
  FULLTIME
  HALFTIME
  KICKOFF
  PENALTY
  OWN_GOAL
  VAR_REVIEW
  CHALLENGE_REVIEW
  TIMEOUT
  INTERCEPT
  REBOUND
  CENTER_PASS
  OBSTRUCTION
  TRY
  CONVERSION
  PENALTY_GOAL
  DROP_GOAL
  SCRUM
  LINEOUT
  MAUL
  RUCK
  KNOCK_ON
  HIGH_TACKLE
  OFFSIDE
  WICKET
  BOUNDARY
  MAIDEN_OVER
  WIDE
  NO_BALL
  BYE
  LEG_BYE
  OVERTHROW
  THREE_POINTER
  FAST_BREAK
  TURNOVER
  OFFENSIVE_FOUL
  TRAVEL
  DOUBLE_DRIBBLE
  TOUCHDOWN
  FIELD_GOAL
  SAFETY
  INTERCEPTION
  FUMBLE
  SACK
  HAT_TRICK
  MAJOR_PENALTY
  MINOR_PENALTY
  FIGHT
}

enum FormationType {
  FOUR_FOUR_TWO
  FOUR_THREE_THREE
  THREE_FIVE_TWO
  FIVE_THREE_TWO
  FIVE_FOUR_ONE
  THREE_FOUR_THREE
  FOUR_TWO_THREE_ONE
  FOUR_ONE_FOUR_ONE
  THREE_THREE_FOUR
  FIVE_TWO_THREE
  TWO_THREE_FIVE
  FOUR_ONE_TWO_THREE
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
  PAST_DUE
  TRIAL
  SUSPENDED
  DOWNGRADED
  PENDING_UPGRADE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
  CANCELLED
  PROCESSING
}

enum WebhookEvent {
  MATCH_CREATED
  MATCH_STARTED
  MATCH_FINISHED
  PLAYER_ADDED
  PLAYER_UPDATED
  PLAYER_INJURED
  TEAM_UPDATED
  SUBSCRIPTION_UPDATED
  PAYMENT_RECEIVED
  USER_CREATED
  USER_DELETED
  RESULT_APPROVED
}

enum AuditActionType {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  ROLE_ASSIGNED
  SUBSCRIPTION_GRANTED
  SUBSCRIPTION_UPGRADED
  PAYMENT_PROCESSED
  DATA_EXPORTED
  DATA_DELETED
  TEAM_CREATED
  MATCH_CREATED
  MATCH_RESULT_UPDATED
  SYSTEM_MAINTENANCE
  API_KEY_GENERATED
  API_KEY_REVOKED
  LOGIN_ATTEMPT
  FAILED_LOGIN
  SUSPICIOUS_LOGIN
}

enum TrainingIntensity {
  RECOVERY
  LOW
  MEDIUM
  HIGH
  MAXIMUM
  COMPETITIVE
}

enum TrainingCategory {
  PASSING
  SHOOTING
  DEFENDING
  POSSESSION
  SET_PIECES
  CONDITIONING
  TACTICAL
  RECOVERY
  STRENGTH_POWER
  SPEED_AGILITY
  FLEXIBILITY
  BALANCE_COORDINATION
  MENTAL_PREPARATION
  VIDEO_ANALYSIS
  TEAM_BUILDING
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
  LEFT_EARLY
  PARTIAL
}

enum LeagueFormat {
  ROUND_ROBIN
  DOUBLE_ROUND_ROBIN
  KNOCKOUT
  GROUP_KNOCKOUT
  ROUND_ROBIN_WITH_PLAYOFFS
  SWISS_SYSTEM
  LADDER_SYSTEM
  CUSTOM
}

enum LeagueVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
  INVITE_ONLY
  FRIENDS_ONLY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  REVOKED
}

enum ResultApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
  REQUIRES_REVISION
  UNDER_REVIEW
}

enum ClubMemberRole {
  OWNER
  MANAGER
  HEAD_COACH
  ASSISTANT_COACH
  PLAYER
  STAFF
  TREASURER
  SCOUT
  ANALYST
  MEDICAL_STAFF
  PHYSIOTHERAPIST
  NUTRITIONIST
  PSYCHOLOGIST
  PERFORMANCE_COACH
  GOALKEEPING_COACH
}

enum TeamType {
  PROFESSIONAL
  SEMI_PROFESSIONAL
  AMATEUR
  ACADEMY
  YOUTH
  RECREATIONAL
}

enum VideoQuality {
  Q_360P
  Q_480P
  Q_720P
  Q_1080P
  Q_2K
  Q_4K
}

enum TranscodingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  QUEUED
}

enum VideoProcessingProvider {
  MUX
  AWS_MEDIACONVERT
  BUNNY_CDN
  CLOUDINARY
  INTERNAL
  VERCEL_BLOB
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  PAID
  DISPUTED
  ARCHIVED
}

enum PaymentType {
  SUBSCRIPTION
  COACHING_FEE
  MATCH_FEE
  TOURNAMENT_FEE
  TRAINING_FEE
  FACILITY_RENTAL
  EQUIPMENT
  REFUND
  BONUS
  SALARY
  COMMISSION
  OTHER
}

// ============================================================================
// üè¢ ORGANISATION & MULTI-TENANCY MODELS
// ============================================================================

model Organisation {
  id                      String   @id @default(cuid())
  slug                    String   @unique @db.VarChar(63)
  
  // Identity
  name                    String
  description             String?  @db.Text
  logo                    String?
  banner                  String?
  website                 String?
  
  // Contact & Location
  email                   String
  phone                   String?
  country                 String
  timezone                String   @default("Europe/London")
  
  // Business
  tier                    OrganisationTier @default(STARTER)
  monthlyBudget           Float?
  currency                String   @default("GBP")
  
  // Compliance
  registrationNumber      String?  @unique
  taxId                   String?  @unique
  complianceStatus        String   @default("PENDING")
  gdprCompliant           Boolean  @default(false)
  dataProcessingAgreement DateTime?
  
  // Usage tracking
  totalUsers              Int      @default(0)
  totalTeams              Int      @default(0)
  totalMatches            Int      @default(0)
  storageUsedMb           Int      @default(0)
  
  // Feature access
  enabledFeatures         String[] @default([])
  customFeatures          Json?
  
  // Quotas
  maxUsers                Int      @default(100)
  maxTeams                Int      @default(10)
  maxStorageMb            Int      @default(5120)
  maxApiCallsPerMonth     Int      @default(10000)
  maxConcurrentUsers      Int      @default(50)
  
  // Billing
  subscriptionId          String?  @unique
  billingEmail            String?
  billingCycle            String   @default("MONTHLY")
  nextBillingDate         DateTime?
  
  // Activity & audit
  lastActivityAt          DateTime?
  isActive                Boolean  @default(true)
  isArchived              Boolean  @default(false)
  archivedAt              DateTime?
  
  // Soft delete
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  owner                   User     @relation("organisationOwner", fields: [ownerId], references: [id])
  ownerId                 String
  members                 OrganisationMember[]
  invitations             OrganisationInvitation[]
  clubs                   Club[]
  apiKeys                 ApiKey[]
  webhooks                Webhook[]
  auditLogs               AuditLog[]
  backups                 DatabaseBackup[]
  subscriptions           Subscription[]
  dataExportRequests      DataExportRequest[]
  dataDeletionRequests    DataDeletionRequest[]
  apiUsageMetrics         ApiUsageMetrics[]
  quotaUsage              QuotaUsage[]
  
  @@index([slug])
  @@index([ownerId])
  @@index([tier])
  @@index([isActive])
  @@index([createdAt])
  @@map("organisations")
}

model OrganisationMember {
  id                      String   @id @default(cuid())
  organisationId          String
  userId                  String
  roleId                  String?
  
  role                    OrganisationRole @default(MEMBER)
  
  // Permissions override
  customPermissions       String[]
  
  // Activity
  joinedAt                DateTime @default(now())
  invitedBy               String?
  invitedAt               DateTime?
  
  // Audit
  lastAccessAt            DateTime?
  lastAccessIp            String?
  
  // Soft delete
  removedAt               DateTime?
  
  organisation            Organisation     @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user                    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  customRole              Role?            @relation("roleMembers", fields: [roleId], references: [id], onDelete: SetNull)
  
  @@unique([organisationId, userId])
  @@index([organisationId])
  @@index([userId])
  @@index([roleId])
  @@index([role])
  @@map("organisation_members")
}

model OrganisationInvitation {
  id                      String   @id @default(cuid())
  organisationId          String
  email                   String
  role                    OrganisationRole @default(MEMBER)
  
  invitedBy               String
  invitedAt               DateTime @default(now())
  expiresAt               DateTime
  
  acceptedAt              DateTime?
  acceptedBy              String?
  
  status                  String   @default("PENDING")
  
  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  @@unique([organisationId, email])
  @@index([organisationId])
  @@index([status])
  @@map("organisation_invitations")
}

// ============================================================================
// üë§ USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique @db.Citext
  emailVerified           DateTime?
  phone                   String?   @unique
  phoneVerified           DateTime?
  
  // Profile
  firstName               String
  lastName                String
  middleName              String?
  displayName             String?
  avatar                  String?
  banner                  String?
  bio                     String?   @db.Text
  dateOfBirth             DateTime?
  nationality             String?
  language                String    @default("en-GB")
  timezone                String    @default("Europe/London")
  
  // Account
  userType                UserType  @default(INDIVIDUAL)
  accountTier             AccountTier @default(FREE)
  roles                   UserRole[] @default([PLAYER])
  status                  UserStatus @default(PENDING_EMAIL_VERIFICATION)
  
  // Primary organisation context
  primaryOrganisationId   String?
  
  // Auth
  password                String?
  passwordChangedAt       DateTime?
  passwordResetToken      String?
  passwordResetExpires    DateTime?
  
  // 2FA & Security
  twoFactorEnabled        Boolean   @default(false)
  twoFactorSecret         String?   @unique
  twoFactorBackupCodes    String[]
  lastLoginAt             DateTime?
  lastLoginIp             String?
  loginAttempts           Int       @default(0)
  lockoutUntil            DateTime?
  
  // Preferences
  emailNotificationsEnabled Boolean  @default(true)
  pushNotificationsEnabled  Boolean  @default(true)
  smsNotificationsEnabled   Boolean  @default(false)
  marketingEmailsEnabled    Boolean  @default(false)
  privacyLevel              String   @default("FRIENDS_ONLY")
  showOnlineStatus          Boolean  @default(true)
  profileVisibility         String   @default("PUBLIC")
  
  // Legal & Compliance
  gdprConsent             Boolean   @default(false)
  gdprConsentDate         DateTime?
  dataProcessingConsent   Boolean   @default(false)
  marketingConsent        Boolean   @default(false)
  cookieConsent           Boolean   @default(false)
  termsAcceptedAt         DateTime?
  privacyPolicyAcceptedAt DateTime?
  
  // Social
  followersCount          Int       @default(0)
  followingCount          Int       @default(0)
  
  // Soft delete
  deletedAt               DateTime?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations - Multi-org
  organisationMemberships OrganisationMember[]
  organisationsOwned      Organisation[]      @relation("organisationOwner")
  
  // Relations - Auth
  accounts                Account[]
  sessions                Session[]
  refreshTokens           RefreshToken[]
  apiKeys                 ApiKey[]
  
  // Relations - Roles
  player                  Player?
  coach                   Coach?
  referee                 Referee?
  scout                   Scout?
  analyst                 Analyst?
  clubManager             ClubManager?
  clubOwner               ClubOwner?
  parent                  Parent?
  treasurer               Treasurer?
  
  // Relations - Clubs & Teams
  clubMemberships         ClubMember[]
  managedClubs            Club[]          @relation("clubManager")
  ownedClubs              Club[]          @relation("clubOwner")
  
  // Relations - Communication
  notifications           Notification[]
  notificationPrefs       NotificationPreference?
  messages                Message[]
  chatMembers             ChatMember[]
  
  // Relations - Social
  socialActions           SocialAction[]
  followers               Follow[]        @relation("follower")
  following               Follow[]        @relation("following")
  blocks                  UserBlock[]     @relation("blocker")
  blockedBy               UserBlock[]     @relation("blocked")
  
  // Relations - Gamification
  achievements            Achievement[]   @relation("achievementUser")
  badges                  Badge[]         @relation("badgeUser")
  
  // Relations - Billing
  subscriptions           Subscription[]
  payments                Payment[]
  invoices                Invoice[]
  
  // Relations - Audit
  auditLogsCreated        AuditLog[]          @relation("auditLogUser")
  
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([primaryOrganisationId])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id                      String  @id @default(cuid())
  userId                  String
  type                    String
  provider                String
  providerAccountId       String
  
  refresh_token           String? @db.Text
  access_token            String? @db.Text
  expires_at              Int?
  token_type              String?
  scope                   String?
  id_token                String? @db.Text
  session_state           String?

  user                    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id                      String   @id @default(cuid())
  sessionToken            String   @unique
  userId                  String
  expires                 DateTime
  
  ipAddress               String?
  userAgent               String?
  
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model RefreshToken {
  id                      String   @id @default(cuid())
  userId                  String
  token                   String   @unique
  expiresAt               DateTime
  revokedAt               DateTime?
  usedAt                  DateTime?
  
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model VerificationToken {
  id                      String   @id @default(cuid())
  identifier              String
  token                   String   @unique
  type                    String   @default("EMAIL")
  expires                 DateTime
  
  @@unique([identifier, token])
  @@index([type])
  @@index([expires])
  @@map("verification_tokens")
}

model ApiKey {
  id                      String   @id @default(cuid())
  userId                  String
  organisationId          String?
  
  name                    String
  key                     String   @unique @db.Char(32)
  secret                  String?  @unique
  lastUsed                DateTime?
  expiresAt               DateTime?
  
  createdAt               DateTime @default(now())
  revokedAt               DateTime?

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation            Organisation? @relation(fields: [organisationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([key])
  @@index([organisationId])
  @@map("api_keys")
}

// ============================================================================
// üîê PERMISSION & ROLE MANAGEMENT - ENTERPRISE RBAC
// ============================================================================

model Role {
  id                      String   @id @default(cuid())
  organisationId          String
  
  name                    String
  slug                    String
  description             String?  @db.Text
  
  // Classification
  isBuiltIn               Boolean  @default(false)
  isCustom                Boolean  @default(true)
  level                   Int      @default(0)
  
  // Permissions
  permissions             String[]
  customPermissionJson    Json?
  
  // Usage
  memberCount             Int      @default(0)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  organisationMembers     OrganisationMember[]  @relation("roleMembers")
  
  @@unique([organisationId, slug])
  @@index([organisationId])
  @@map("roles")
}

model Permission {
  id                      String   @id @default(cuid())
  
  type                    PermissionType @unique
  description             String?
  category                String
  
  @@map("permissions")
}

model ResourcePermission {
  id                      String   @id @default(cuid())
  
  resourceType            String
  resourceId              String
  
  userId                  String
  permission              String
  
  grantedAt               DateTime @default(now())
  grantedBy               String
  expiresAt               DateTime?
  
  @@unique([resourceType, resourceId, userId, permission])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@map("resource_permissions")
}

// ============================================================================
// üìã AUDIT, COMPLIANCE & DATA GOVERNANCE
// ============================================================================

model AuditLog {
  id                      String   @id @default(cuid())
  organisationId          String
  userId                  String?
  
  action                  AuditActionType
  
  // Resource tracking
  resourceType            String
  resourceId              String
  
  // What changed
  beforeState             Json?
  afterState              Json?
  changes                 String[]
  
  // Context
  ipAddress               String?
  userAgent               String?
  sessionId               String?
  
  // Metadata
  severity                String   @default("INFO")
  isCompliance            Boolean  @default(false)
  requiresReview          Boolean  @default(false)
  isLegalHold             Boolean  @default(false)
  legalHoldReason         String?
  
  createdAt               DateTime @default(now())
  
  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user                    User?    @relation("auditLogUser", fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([organisationId])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([severity])
  @@map("audit_logs")
}

model EntityVersion {
  id                      String   @id @default(cuid())
  
  entityType              String
  entityId                String
  version                 Int
  
  // Complete snapshot
  data                    Json
  
  // Change metadata
  changedBy               String
  changeReason            String?
  changeType              String
  
  // Retention policy
  retentionPolicy         DataRetentionPolicy @default(STANDARD)
  deletionScheduledAt     DateTime?
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  
  @@unique([entityType, entityId, version])
  @@index([entityType, entityId])
  @@index([deletionScheduledAt])
  @@map("entity_versions")
}

model ConsentLog {
  id                      String   @id @default(cuid())
  userId                  String
  
  type                    String
  
  granted                 Boolean
  grantedAt               DateTime
  
  evidence                Json?
  
  @@index([userId])
  @@map("consent_logs")
}

model DataExportRequest {
  id                      String   @id @default(cuid())
  userId                  String
  organisationId          String
  
  status                  String   @default("PENDING")
  
  requestedAt             DateTime @default(now())
  processedAt             DateTime?
  expiresAt               DateTime
  
  fileUrl                 String?
  fileSize                Int?
  
  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@map("data_export_requests")
}

model DataDeletionRequest {
  id                      String   @id @default(cuid())
  userId                  String
  organisationId          String
  
  reason                  String?
  requestedAt             DateTime @default(now())
  
  status                  String   @default("PENDING")
  approvedAt              DateTime?
  completedAt             DateTime?
  
  verificationToken       String?  @unique
  verificationSentAt      DateTime?
  
  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@map("data_deletion_requests")
}

// ============================================================================
// üèÉ PLAYER MODELS - ENHANCED FOR ANALYTICS
// ============================================================================

model Player {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  // Physical attributes
  height                  Float?
  weight                  Float?
  dateOfBirth             DateTime?
  nationality             String?
  secondNationality       String?
  
  // Football specifics
  jerseyNumber            Int?
  preferredFoot           PreferredFoot?
  primaryPosition         Position?
  secondaryPosition       Position?
  
  // Market & contract
  marketValue             Float?
  valueLastUpdated        DateTime?
  currency                String    @default("GBP")
  
  // Status
  isActive                Boolean   @default(true)
  isVerified              Boolean   @default(false)
  hasCompletedProfile     Boolean   @default(false)
  isAcademy               Boolean   @default(false)
  isYouth                 Boolean   @default(false)
  youthCategory           String?
  
  // Ratings & performance
  overallRating           Float?    @default(0)
  formRating              Float?    @default(0)
  developmentPhase        String?
  fitnessLevel            Float?
  injuryStatus            String?
  lastFitnessTest         DateTime?
  
  // Soft delete
  deletedAt               DateTime?
  
  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  statistics              PlayerStatistic[]
  aggregateStats          PlayerAggregateStats?
  analytics               PlayerAnalytic?   @relation("playerAnalytics")
  insights                PlayerInsight?    @relation("playerInsights")
  contracts               Contract[]
  injuries                Injury[]
  matchAttendance         MatchAttendance[]
  familyLinks             PlayerFamily[]
  scoutingReports         ScoutingReport[]
  highlights              PlayerHighlight[]
  badges                  Badge[]           @relation("badgePlayer")
  achievements            Achievement[]     @relation("achievementPlayer")
  
  @@index([userId])
  @@index([isActive])
  @@index([isVerified])
  @@index([primaryPosition])
  @@index([marketValue])
  @@index([createdAt])
  @@map("players")
}

model PlayerStatistic {
  id                      String   @id @default(cuid())
  playerId                String
  season                  Int
  teamId                  String?
  leagueId                String?
  
  // Core stats
  matches                 Int      @default(0)
  minutesPlayed           Int      @default(0)
  goals                   Int      @default(0)
  assists                 Int      @default(0)
  ownGoals                Int      @default(0)
  
  // Disciplinary
  yellowCards             Int      @default(0)
  redCards                Int      @default(0)
  
  // Technical
  passes                  Int      @default(0)
  passAccuracy            Float?
  tackles                 Int      @default(0)
  interceptions           Int      @default(0)
  clearances              Int      @default(0)
  
  // Shooting
  shots                   Int      @default(0)
  shotsOnTarget           Int      @default(0)
  
  // Sport-specific
  sportSpecificStats      Json?
  
  lastUpdated             DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season, teamId, leagueId])
  @@index([playerId])
  @@index([season])
  @@map("player_statistics")
}

model PlayerAggregateStats {
  id                      String   @id @default(cuid())
  playerId                String   @unique
  
  // Career totals
  totalMatches            Int      @default(0)
  totalGoals              Int      @default(0)
  totalAssists            Int      @default(0)
  totalMinutes            Int      @default(0)
  
  // Averages
  avgGoalsPerMatch        Float    @default(0)
  avgAssistsPerMatch      Float    @default(0)
  avgMinutesPerMatch      Float    @default(0)
  avgRating               Float    @default(0)
  
  // Season current
  seasonGoals             Int      @default(0)
  seasonAssists           Int      @default(0)
  seasonMatches           Int      @default(0)
  
  // Rankings
  positionRank            Int?
  leagueRank              Int?
  
  lastUpdatedAt           DateTime @default(now())
  refreshedAt             DateTime @default(now())
  
  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  @@index([playerId])
  @@index([lastUpdatedAt])
  @@map("player_aggregate_stats")
}

model PlayerAnalytic {
  id                      String   @id @default(cuid())
  playerId                String   @unique
  
  // Ratings
  overallRating           Float    @default(0)
  formRating              Float    @default(0)
  consistencyIndex        Float    @default(0)
  injuryRisk              Float    @default(0)
  developmentPotential    Float    @default(0)
  fatigueLevelEstimate    Float    @default(0)
  
  // Rankings
  positionRank            Int?
  leagueRank              Int?
  globalRank              Int?
  
  // Trends
  weeklyTrend             Float?
  monthlyTrend            Float?
  seasonTrend             Float?
  
  // Performance
  lastMatchRating         Float?
  last5MatchesAvg         Float?
  seasonAverage           Float?
  
  // Predictions
  predictions             Json?
  predictionConfidence    Float?
  
  // Development
  strengths               String[]
  weaknesses              String[]
  developmentAreas        String[]
  recommendations         String?  @db.Text
  lastAnalysisDate        DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation("playerAnalytics", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([overallRating])
  @@index([injuryRisk])
  @@map("player_analytics")
}

model PlayerInsight {
  id                      String   @id @default(cuid())
  playerId                String   @unique
  
  // Analysis
  strengths               String[]
  weaknesses              String[]
  developmentAreas        String[]
  playingStyle            String?
  strongFoot              String?
  
  // Attributes
  aggressiveness          Float?
  defensiveAbility        Float?
  passAccuracy            Float?
  shootingAccuracy        Float?
  leadership              Float?
  teamwork                Float?
  situationalAwareness    Float?
  
  // Guidance
  recommendations         String?  @db.Text
  careerAdvice            String?  @db.Text
  lastReviewDate          DateTime?
  reviewedBy              String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation("playerInsights", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@map("player_insights")
}

model PlayerFamily {
  id                      String   @id @default(cuid())
  playerId                String
  parentId                String?
  guardianId              String?
  relationship            String
  
  createdAt               DateTime @default(now())

  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@map("player_family")
}

model PlayerHighlight {
  id                      String   @id @default(cuid())
  playerId                String
  matchId                 String?
  
  title                   String
  description             String?  @db.Text
  videoUrl                String?
  thumbnailUrl            String?
  duration                Int?
  highlightType           String
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([matchId])
  @@map("player_highlights")
}

model Injury {
  id                      String   @id @default(cuid())
  playerId                String
  
  type                    String
  severity                String   @default("MINOR")
  location                String
  
  dateFrom                DateTime
  dateTo                  DateTime?
  estimatedReturn         DateTime?
  actualReturn            DateTime?
  
  description             String?  @db.Text
  treatment               String?
  therapist               String?
  status                  String   @default("ACTIVE")
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([dateFrom])
  @@index([status])
  @@map("injuries")
}

model Contract {
  id                      String   @id @default(cuid())
  playerId                String
  clubId                  String?
  
  position                Position
  
  // Financial
  salary                  Float?
  currency                String    @default("GBP")
  bonusStructure          Json?
  performanceBonus        Float?
  signOnBonus             Float?
  
  // Dates
  startDate               DateTime
  endDate                 DateTime?
  
  // Terms
  contractType            String    @default("PROFESSIONAL")
  status                  String    @default("ACTIVE")
  contractDocument        String?
  
  // Extensions & clauses
  extensionOption         Boolean   @default(false)
  extensionDate           DateTime?
  extensionYears          Int?
  buyoutClause            Float?
  releaseClause           Float?
  
  // Agent
  agentName               String?
  agentEmail              String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([status])
  @@map("contracts")
}

// ============================================================================
// üèÜ COACH MODELS - ENHANCED FOR PAYMENTS & TIMESHEETS
// ============================================================================

model Coach {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  // Professional details
  coachType               String    @default("HEAD_COACH")
  specialization          String[]
  certifications          String[]
  yearsExperience         Int?
  qualifications          String[]  @db.Text
  bio                     String?   @db.Text
  
  // Payment & contract
  hourlyRate              Float?
  currency                String    @default("GBP")
  bankDetails             Json?
  taxId                   String?
  contractType            String?
  
  // Verification
  isVerified              Boolean   @default(false)
  verificationDate        DateTime?
  licenseNumber           String?   @unique
  licenseExpiry           DateTime?
  backgroundCheckExpiry   DateTime?
  
  // Performance metrics
  overallRating           Float?    @default(0)
  totalPlayersCoached     Int       @default(0)
  successRate             Float?
  
  // Availability
  isAvailable             Boolean   @default(true)
  availabilityNotes       String?
  
  // Soft delete
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  clubMemberships         ClubMember[]      @relation("coachMemberships")
  trainingSessions        TrainingSession[]
  timesheets              CoachTimesheet[]  @relation("coach")
  payments                CoachPayment[]
  achievements            Achievement[]     @relation("achievementCoach")
  
  @@index([userId])
  @@index([isVerified])
  @@map("coaches")
}

model CoachTimesheet {
  id                      String   @id @default(cuid())
  coachId                 String
  clubId                  String?
  
  weekStartDate           DateTime
  weekEndDate             DateTime
  
  totalHours              Float    @default(0)
  hourlyCost              Float?
  totalCost               Float?
  
  description             String?  @db.Text
  attachments             String[]
  
  status                  TimesheetStatus @default(DRAFT)
  submittedAt             DateTime?
  approvedAt              DateTime?
  approvedBy              String?
  rejectionReason         String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  coach                   Coach    @relation("coach", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([status])
  @@map("coach_timesheets")
}

model CoachPayment {
  id                      String   @id @default(cuid())
  coachId                 String
  
  amount                  Float
  currency                String   @default("GBP")
  paymentDate             DateTime
  paymentMethod           String
  
  invoiceNumber           String?  @unique
  reference               String?
  
  status                  PaymentStatus @default(PENDING)
  description             String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  coach                   Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([status])
  @@map("coach_payments")
}

// ============================================================================
// ü§ù OTHER STAFF MODELS
// ============================================================================

model Referee {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  licenseNumber           String?  @unique
  licenseLevel            String?
  yearsOfExperience       Int?
  specialization          String[]
  
  certificationDate       DateTime?
  certificationExpiry     DateTime?
  backgroundCheckExpiry   DateTime?
  
  assignedMatches         Int      @default(0)
  isVerified              Boolean  @default(false)
  isActive                Boolean  @default(true)
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches                 Match[]  @relation("matchReferee")

  @@index([userId])
  @@index([isVerified])
  @@map("referees")
}

model Scout {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  specialization          String[]
  region                  String?
  yearsExperience         Int?
  focusAgeGroup           String?
  
  isVerified              Boolean   @default(false)
  isActive                Boolean   @default(true)
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  scoutingReports         ScoutingReport[]

  @@index([userId])
  @@index([isVerified])
  @@map("scouts")
}

model Analyst {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  specialization          String[]
  tools                   String[]
  yearsExperience         Int?
  
  isVerified              Boolean   @default(false)
  isActive                Boolean   @default(true)
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isVerified])
  @@map("analysts")
}

model ClubManager {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  managingStyle           String?
  yearsExperience         Int?
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("club_managers")
}

model ClubOwner {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  businessType            String?
  yearsInBusiness         Int?
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("club_owners")
}

model Parent {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  childrenCount           Int      @default(0)
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("parents")
}

model Treasurer {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  yearsExperience         Int?
  bankDetails             Json?
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("treasurers")
}

// ============================================================================
// üè¢ CLUB & TEAM MODELS
// ============================================================================

model Club {
  id                      String   @id @default(cuid())
  organisationId          String?
  name                    String
  slug                    String   @unique
  description             String?  @db.Text
  logo                    String?
  banner                  String?
  website                 String?
  email                   String?
  phone                   String?
  foundedYear             Int?
  
  // Location
  city                    String?
  state                   String?
  country                 String?
  address                 String?
  postcode                String?
  venue                   String?
  venueCapacity           Int?
  
  // Sport & type
  sport                   Sport
  teamType                TeamType @default(AMATEUR)
  
  // Management
  managerId               String
  ownerId                 String?
  
  // Status
  isVerified              Boolean   @default(false)
  isPublic                Boolean   @default(true)
  acceptingPlayers        Boolean   @default(true)
  
  // Metrics
  followerCount           Int       @default(0)
  joinedMembers           Int       @default(0)
  
  // Soft delete
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  organisation            Organisation?     @relation(fields: [organisationId], references: [id], onDelete: SetNull)
  manager                 User              @relation("clubManager", fields: [managerId], references: [id])
  owner                   User?             @relation("clubOwner", fields: [ownerId], references: [id])
  members                 ClubMember[]
  teams                   Team[]
  leagues                 League[]
  formations              TeamFormation[]
  tactics                 Tactic[]
  trainingSessions        TrainingSession[]
  homeMatches             Match[]           @relation("homeTeam")
  awayMatches             Match[]           @relation("awayTeam")
  aggregateStats          TeamAggregateStats?
  
  @@index([organisationId])
  @@index([managerId])
  @@index([ownerId])
  @@index([sport])
  @@index([isPublic])
  @@index([city])
  @@map("clubs")
}

model ClubMember {
  id                      String   @id @default(cuid())
  userId                  String
  clubId                  String
  coachId                 String?
  
  role                    ClubMemberRole @default(STAFF)
  
  joinedAt                DateTime  @default(now())
  leftAt                  DateTime?
  isActive                Boolean   @default(true)
  isCaptain               Boolean   @default(false)
  
  salary                  Float?
  currency                String    @default("GBP")
  
  deletedAt               DateTime?

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  club                    Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coach                   Coach?   @relation("coachMemberships", fields: [coachId], references: [id], onDelete: SetNull)

  @@unique([userId, clubId])
  @@index([userId])
  @@index([clubId])
  @@index([coachId])
  @@index([role])
  @@map("club_members")
}

model Team {
  id                      String   @id @default(cuid())
  clubId                  String
  
  name                    String
  description             String?  @db.Text
  logo                    String?
  ageGroup                String?
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  club                    Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  players                 TeamPlayer[]
  matchSquads             MatchSquad[]
  formations              TeamFormation[]

  @@unique([clubId, name])
  @@index([clubId])
  @@map("teams")
}

model TeamPlayer {
  id                      String   @id @default(cuid())
  teamId                  String
  playerId                String?
  
  position                Position?
  jerseyNumber            Int?
  isActive                Boolean   @default(true)
  
  joinedAt                DateTime @default(now())

  team                    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@index([teamId])
  @@map("team_players")
}

model TeamFormation {
  id                      String   @id @default(cuid())
  clubId                  String
  teamId                  String?
  
  formation               FormationType @default(FOUR_FOUR_TWO)
  description             String?
  diagram                 Json?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  club                    Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  team                    Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([clubId])
  @@map("team_formations")
}

// ============================================================================
// üèÜ LEAGUE & COMPETITION MODELS
// ============================================================================

model League {
  id                      String   @id @default(cuid())
  clubId                  String
  
  name                    String
  description             String?  @db.Text
  season                  Int
  
  startDate               DateTime
  endDate                 DateTime?
  registrationDeadline    DateTime?
  
  format                  LeagueFormat     @default(ROUND_ROBIN)
  visibility              LeagueVisibility @default(PRIVATE)
  status                  String           @default("DRAFT")
  
  maxTeams                Int?
  teamsRegistered         Int      @default(0)
  
  logo                    String?
  rules                   String?  @db.Text
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  club                    Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  teams                   LeagueTeam[]
  matches                 Match[]
  standings               LeagueStanding[]
  aggregateStats          LeagueAggregateStats?

  @@index([clubId])
  @@index([status])
  @@map("leagues")
}

model LeagueTeam {
  id                      String   @id @default(cuid())
  leagueId                String
  teamId                  String?
  clubId                  String?
  
  joinedAt                DateTime @default(now())
  leftAt                  DateTime?

  league                  League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@map("league_teams")
}

model LeagueStanding {
  id                      String   @id @default(cuid())
  leagueId                String
  teamId                  String?
  
  position                Int
  wins                    Int      @default(0)
  draws                   Int      @default(0)
  losses                  Int      @default(0)
  goalsFor                Int      @default(0)
  goalsAgainst            Int      @default(0)
  goalDifference          Int      @default(0)
  points                  Int      @default(0)
  
  updatedAt               DateTime @updatedAt

  league                  League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, teamId])
  @@index([leagueId])
  @@map("league_standings")
}

model LeagueAggregateStats {
  id                      String   @id @default(cuid())
  leagueId                String   @unique
  
  totalMatches            Int      @default(0)
  totalGoals              Int      @default(0)
  avgGoalsPerMatch        Float    @default(0)
  
  lastUpdatedAt           DateTime @default(now())
  
  league                  League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  
  @@index([leagueId])
  @@map("league_aggregate_stats")
}

// ============================================================================
// ‚öΩ MATCH & EVENT MODELS
// ============================================================================

model Match {
  id                      String   @id @default(cuid())
  leagueId                String?
  homeClubId              String
  awayClubId              String
  
  title                   String?
  description             String?  @db.Text
  
  kickOffTime             DateTime
  status                  MatchStatus @default(SCHEDULED)
  
  venue                   String?
  refereeId               String?
  
  // Score
  homeScore               Int?
  awayScore               Int?
  homeHalftimeScore       Int?
  awayHalftimeScore       Int?
  
  // Attendance
  attendance              Int?
  capacity                Int?
  
  // Duration
  actualDuration          Int?
  
  // Approval
  resultApprovalStatus    ResultApprovalStatus @default(PENDING)
  approvedBy              String?
  approvedAt              DateTime?
  
  // Metadata
  isHighlighted           Boolean   @default(false)
  isFeatured              Boolean   @default(false)
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  league                  League?           @relation(fields: [leagueId], references: [id], onDelete: SetNull)
  homeTeam                Club              @relation("homeTeam", fields: [homeClubId], references: [id])
  awayTeam                Club              @relation("awayTeam", fields: [awayClubId], references: [id])
  referee                 Referee?          @relation("matchReferee", fields: [refereeId], references: [id], onDelete: SetNull)
  events                  MatchEvent[]
  squads                  MatchSquad[]
  attendance              MatchAttendance[]
  stats                   MatchStat[]
  
  @@index([leagueId])
  @@index([homeClubId])
  @@index([awayClubId])
  @@index([status])
  @@index([kickOffTime])
  @@map("matches")
}

model MatchEvent {
  id                      String   @id @default(cuid())
  matchId                 String
  playerId                String?
  
  eventType               MatchEventType
  minute                  Int
  secondaryMinute         Int?
  
  details                 Json?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  match                   Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([eventType])
  @@map("match_events")
}

model MatchSquad {
  id                      String   @id @default(cuid())
  matchId                 String
  teamId                  String
  playerId                String?
  
  lineupPosition          Int?
  shirtNumber             Int?
  
  status                  MatchAttendanceStatus @default(NOT_SELECTED)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  match                   Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team                    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([teamId])
  @@map("match_squads")
}

model MatchAttendance {
  id                      String   @id @default(cuid())
  matchId                 String
  playerId                String
  
  status                  MatchAttendanceStatus @default(AVAILABLE)
  notesFromPlayer         String?
  
  minutesPlayed           Int?
  rating                  Float?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  match                   Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@map("match_attendance")
}

model MatchStat {
  id                      String   @id @default(cuid())
  matchId                 String
  playerId                String?
  teamId                  String?
  
  goals                   Int      @default(0)
  assists                 Int      @default(0)
  passes                  Int      @default(0)
  passAccuracy            Float?
  tackles                 Int      @default(0)
  interceptions           Int      @default(0)
  
  customStats             Json?
  
  updatedAt               DateTime @updatedAt

  match                   Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@map("match_stats")
}

// ============================================================================
// üìä ADDITIONAL SUPPORTING MODELS
// ============================================================================

model TrainingSession {
  id                      String   @id @default(cuid())
  clubId                  String
  coachId                 String
  
  name                    String
  description             String?  @db.Text
  
  startTime               DateTime
  endTime                 DateTime
  
  intensity               TrainingIntensity @default(MEDIUM)
  category                TrainingCategory
  
  location                String?
  maxParticipants         Int?
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  club                    Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  coach                   Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([coachId])
  @@map("training_sessions")
}

model ScoutingReport {
  id                      String   @id @default(cuid())
  scoutId                 String
  playerId                String
  
  rating                  Float?
  observations            String?  @db.Text
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  scout                   Scout    @relation(fields: [scoutId], references: [id], onDelete: Cascade)
  player                  Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([scoutId])
  @@index([playerId])
  @@map("scouting_reports")
}

model Tactic {
  id                      String   @id @default(cuid())
  clubId                  String
  
  name                    String
  description             String?  @db.Text
  diagram                 Json?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  club                    Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@map("tactics")
}

model TeamAggregateStats {
  id                      String   @id @default(cuid())
  clubId                  String   @unique
  
  totalMatches            Int      @default(0)
  totalWins               Int      @default(0)
  totalDraws              Int      @default(0)
  totalLosses             Int      @default(0)
  totalGoalsFor           Int      @default(0)
  totalGoalsAgainst       Int      @default(0)
  
  lastUpdatedAt           DateTime @default(now())
  
  club                    Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  
  @@index([clubId])
  @@map("team_aggregate_stats")
}

// ============================================================================
// üí∞ BILLING & SUBSCRIPTION MODELS
// ============================================================================

model Subscription {
  id                      String   @id @default(cuid())
  userId                  String?
  organisationId          String?
  
  stripeSubscriptionId    String?  @unique
  stripeCustomerId        String?
  
  status                  SubscriptionStatus @default(ACTIVE)
  tier                    AccountTier @default(FREE)
  
  currentPeriodStart      DateTime
  currentPeriodEnd        DateTime
  
  trialStart              DateTime?
  trialEnd                DateTime?
  
  cancelledAt             DateTime?
  cancelledReason         String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation            Organisation?    @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organisationId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id                      String   @id @default(cuid())
  userId                  String?
  
  amount                  Float
  currency                String   @default("GBP")
  
  status                  PaymentStatus @default(PENDING)
  type                    PaymentType @default(SUBSCRIPTION)
  
  stripePaymentIntentId   String?  @unique
  
  description             String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id                      String   @id @default(cuid())
  userId                  String
  
  invoiceNumber           String   @unique
  amount                  Float
  currency                String   @default("GBP")
  
  issuedAt                DateTime
  dueAt                   DateTime
  paidAt                  DateTime?
  
  status                  String   @default("ISSUED")
  
  pdfUrl                  String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("invoices")
}

// ============================================================================
// üì± NOTIFICATIONS & MESSAGING
// ============================================================================

model Notification {
  id                      String   @id @default(cuid())
  userId                  String
  
  title                   String
  message                 String   @db.Text
  type                    String
  
  read                    Boolean  @default(false)
  readAt                  DateTime?
  
  link                    String?
  metadata                Json?
  
  createdAt               DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model NotificationPreference {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  emailMatches            Boolean  @default(true)
  emailTeam               Boolean  @default(true)
  emailCoach              Boolean  @default(true)
  emailNews               Boolean  @default(false)
  
  pushMatches             Boolean  @default(true)
  pushTeam                Boolean  @default(true)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model Message {
  id                      String   @id @default(cuid())
  senderId                String
  chatId                  String
  
  content                 String   @db.Text
  
  readBy                  String[] @default([])
  
  deletedAt               DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  sender                  User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([chatId])
  @@map("messages")
}

model ChatMember {
  id                      String   @id @default(cuid())
  userId                  String
  chatId                  String
  
  joinedAt                DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@map("chat_members")
}

// ============================================================================
// üë• SOCIAL & GAMIFICATION
// ============================================================================

model Follow {
  id                      String   @id @default(cuid())
  followerId              String
  followingId             String
  
  createdAt               DateTime @default(now())

  follower                User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following               User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model UserBlock {
  id                      String   @id @default(cuid())
  blockerId               String
  blockedId               String
  
  reason                  String?
  
  createdAt               DateTime @default(now())

  blocker                 User     @relation("blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked                 User     @relation("blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@map("user_blocks")
}

model SocialAction {
  id                      String   @id @default(cuid())
  userId                  String
  
  type                    String
  resourceId              String
  resourceType            String
  
  createdAt               DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceType])
  @@map("social_actions")
}

model Achievement {
  id                      String   @id @default(cuid())
  
  userId                  String?
  playerId                String?
  coachId                 String?
  
  type                    String
  title                   String
  description             String?  @db.Text
  
  unlockedAt              DateTime @default(now())
  
  user                    User?    @relation("achievementUser", fields: [userId], references: [id], onDelete: Cascade)
  player                  Player?  @relation("achievementPlayer", fields: [playerId], references: [id], onDelete: Cascade)
  coach                   Coach?   @relation("achievementCoach", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([playerId])
  @@index([coachId])
  @@map("achievements")
}

model Badge {
  id                      String   @id @default(cuid())
  
  userId                  String?
  playerId                String?
  
  name                    String
  description             String?
  icon                    String?
  
  awardedAt               DateTime @default(now())
  
  user                    User?    @relation("badgeUser", fields: [userId], references: [id], onDelete: Cascade)
  player                  Player?  @relation("badgePlayer", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([playerId])
  @@map("badges")
}

// ============================================================================
// üîå API & INTEGRATIONS
// ============================================================================

model Webhook {
  id                      String   @id @default(cuid())
  organisationId          String
  
  event                   WebhookEvent
  url                     String
  
  isActive                Boolean  @default(true)
  secret                  String?
  
  failureCount            Int      @default(0)
  lastFailedAt            DateTime?
  lastSuccessAt           DateTime?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@index([event])
  @@map("webhooks")
}

model ApiUsageMetrics {
  id                      String   @id @default(cuid())
  organisationId          String
  
  callsThisMonth          Int      @default(0)
  callsLastMonth          Int      @default(0)
  averageResponseTime     Float?
  
  updatedAt               DateTime @updatedAt

  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@map("api_usage_metrics")
}

model QuotaUsage {
  id                      String   @id @default(cuid())
  organisationId          String
  
  usersUsed               Int      @default(0)
  teamsUsed               Int      @default(0)
  storageUsedMb           Int      @default(0)
  apiCallsUsedThisMonth   Int      @default(0)
  
  updatedAt               DateTime @updatedAt

  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@map("quota_usage")
}

// ============================================================================
// üîÑ BACKUP & MAINTENANCE
// ============================================================================

model DatabaseBackup {
  id                      String   @id @default(cuid())
  organisationId          String
  
  size                    Int
  status                  String   @default("COMPLETED")
  
  backupUrl               String?
  expiresAt               DateTime
  
  createdAt               DateTime @default(now())

  organisation            Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId])
  @@index([expiresAt])
  @@map("database_backups")
}